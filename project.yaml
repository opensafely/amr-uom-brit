version: '3.0'

expectations:
  population_size: 1000

actions:

  # generate_study_population:
  #   run: cohortextractor:latest generate_cohort --study-definition study_definition --index-date-range "2019-01-01 to today by month" --skip-existing --output-dir=output/measures --output-format=csv.gz
  #   outputs:
  #     highly_sensitive:
  #       cohort: output/measures/input_*.csv.gz

  generate_study_population_hospitalisation_1:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_hospitalisation --index-date-range "2019-01-01 to 2019-03-01 by month" --output-dir=output/hospitalisation_data --output-format=csv.gz
    outputs:
      highly_sensitive:
        cohort: output/hospitalisation_data/input_hospitalisation_*.csv.gz

  generate_study_population_hospitalisation_2:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_hospitalisation --index-date-range "2019-04-01 to 2019-06-01 by month" --output-dir=output/hospitalisation_data --output-format=csv.gz
    outputs:
      highly_sensitive:
        cohort: output/hospitalisation_data/input_hospitalisatio*.csv.gz

  generate_study_population_hospitalisation_3:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_hospitalisation --index-date-range "2019-07-01 to 2019-09-01 by month" --output-dir=output/hospitalisation_data --output-format=csv.gz
    outputs:
      highly_sensitive:
        cohort: output/hospitalisation_data/input_hospitalisati*.csv.gz

  generate_study_population_hospitalisation_4:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_hospitalisation --index-date-range "2019-10-01 to 2019-12-01 by month" --output-dir=output/hospitalisation_data --output-format=csv.gz
    outputs:
      highly_sensitive:
        cohort: output/hospitalisation_data/input_hospitalisat*.csv.gz

  # generate_measures:
  #   run: cohortextractor:latest generate_measures --study-definition study_definition --skip-existing --output-dir=output/measures
  #   needs: [generate_study_population]
  #   outputs:
  #     moderately_sensitive:
  #       measure_csv: output/measures/measure_*.csv
         
  #generate_notebook_starpu:
  #  run: jupyter:latest jupyter nbconvert /workspace/analysis/starpu.ipynb --execute --to html --output-dir=/workspace/output/hospitalisation_risk --ExecutePreprocessor.timeout=86400
  #  needs: [generate_measures]
  #  outputs:
  #    moderately_sensitive:
  #      notebook: output/hospitalisation_risk/starpu.html 
  #      figures: output/hospitalisation_risk/*
        #tables: output/tables/*
        #csvs: output/*/* # two possible subfolders
        #text: output/text/*

  # generate_notebook_hospitalisation_analysis:
  #   run: jupyter:latest jupyter nbconvert /workspace/analysis/hospitalisation_analysis.ipynb --execute --to html --output-dir=/workspace/output/hospitalisation_risk --ExecutePreprocessor.timeout=86400
  #   needs: [generate_study_population_hospitalisation]
  #   outputs:
  #     moderately_sensitive:
  #       notebook: output/hospitalisation_risk/hospitalisation_analysis.html 
  #       figures: output/hospitalisation_risk/*

  # generate_notebook_hospitalisation_prediction_uti:
  #   run: jupyter:latest jupyter nbconvert /workspace/analysis/hospitalisation_prediction_uti.ipynb --execute --to html --output-dir=/workspace/output/hospitalisation_prediction_uti --ExecutePreprocessor.timeout=86400
  #   needs: [generate_study_population_hospitalisation]
  #   outputs:
  #     moderately_sensitive:
  #       notebook: output/hospitalisation_prediction_uti/hospitalisation_prediction_uti.html 
  #       figures: output/hospitalisation_prediction_uti/*

  describe_hospitalisation_reading_csv_urti:
    run: r:latest analysis/hospitalisation_reading_csv_urti.R
    needs: [generate_study_population_hospitalisation_1, generate_study_population_hospitalisation_2, generate_study_population_hospitalisation_3, generate_study_population_hospitalisation_4]
    outputs:
       moderately_sensitive:
        rds1: output/hospitalisation_data/data2019.csv.gz

  generate_notebook_hospitalisation_prediction_urti:
    run: jupyter:latest jupyter nbconvert /workspace/analysis/hospitalisation_prediction_urti.ipynb --execute --to html --output-dir=/workspace/output/hospitalisation_prediction_urti --ExecutePreprocessor.timeout=86400
    needs: [describe_hospitalisation_reading_csv_urti]
    # , generate_study_population_hospitalisation_3, generate_study_population_hospitalisation_4]
    outputs:
      moderately_sensitive:
        notebook: output/hospitalisation_prediction_urti/hospitalisation_prediction_urti.html 
        figures: output/hospitalisation_prediction_urti/*
  
  # generate_notebook_hospitalisation_prediction:
  #   run: jupyter:latest jupyter nbconvert /workspace/analysis/hospitalisation_prediction.ipynb --execute --to html --output-dir=/workspace/output/hospitalisation_prediction --ExecutePreprocessor.timeout=86400
  #   needs: [generate_study_population_hospitalisation]
  #   outputs:
  #     moderately_sensitive:
  #       notebook: output/hospitalisation_prediction/hospitalisation_prediction.html 
  #       figures: output/hospitalisation_prediction/*

