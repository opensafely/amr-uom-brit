version: '3.0'

expectations:
  population_size: 1000

actions:

  generate_study_population:
    run: cohortextractor:latest generate_cohort --study-definition study_definition --index-date-range "2019-01-01 to today by month" --skip-existing --output-dir=output/measures --output-format=csv.gz
    outputs:
      highly_sensitive:
        cohort: output/measures/input_*.csv.gz
  
  generate_study_population_infection:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_infection --index-date-range "2019-01-01 to today by month" --skip-existing --output-dir=output/measures --output-format=csv.gz
    outputs:
      highly_sensitive:
        cohort: output/measures/input_infection_*.csv.gz

  generate_study_population_elderly:
    run: cohortextractor:latest generate_cohort --study-definition study_definition_elderly 
      --output-format=csv.gz
    outputs:
      highly_sensitive:
        cohort: output/input_elderly.csv.gz

  generate_measures:
    run: cohortextractor:latest generate_measures --study-definition study_definition --skip-existing --output-dir=output/measures
    needs: [generate_study_population]
    outputs:
      moderately_sensitive:
        measure_csv: output/measures/measure_*.csv
  
  generate_measures_infection:
    run: cohortextractor:latest generate_measures --study-definition study_definition_infection --skip-existing --output-dir=output/measures
    needs: [generate_study_population_infection]
    outputs:
      moderately_sensitive:
        measure_csv: output/measures/measure_infection_*.csv
        
  # describe_elderly_agedis:
  #   run: r:latest analysis/tables/gen_csv_age_check.R
  #   needs: [generate_study_population_elderly]
  #   outputs:
  #     moderately_sensitive:
  #       agetable: output/age_quant.csv

  # describe:
  #   run: r:latest analysis/plot/overall_ab_prescribing.R
  #   needs: [generate_measures]
  #   outputs:
  #     moderately_sensitive:
  #       cohort: output/overall.png
  #       boxplot: output/overallbox.png

  # describe_percentile:
  #   run: r:latest analysis/plot/overall_ab_prescribing_2575percentile.R
  #   needs: [generate_measures]
  #   outputs:
  #     moderately_sensitive:
  #       percentile: output/overall_25th_75th_percentile.png
  #       table_total: output/total_number_antibacterial_prescriptions.csv

  # describe_starpu:
  #   run: r:latest analysis/plot/starpu_ab_prescribing.R
  #   needs: [generate_measures]
  #   outputs:
  #     moderately_sensitive:
  #       cohort: output/starpuline.png
  #       boxplot: output/starpubox.png
  
  # generate_notebook_starpu:
  #   run: jupyter:latest jupyter nbconvert /workspace/analysis/starpu.ipynb --execute --to html --output-dir=/workspace/output --ExecutePreprocessor.timeout=86400
  #   needs: [generate_measures]
  #   outputs:
  #     moderately_sensitive:
  #       notebook: output/starpu.html 
  #       figures: output/*
  #       #tables: output/tables/*
  #       #csvs: output/*/* # two possible subfolders
  #       #text: output/text/*
  
  describe_service_eval_baseline_table:
    run: r:latest analysis/tables/baseline_table.R
    needs: [generate_study_population]
    outputs:
      moderately_sensitive:
        baseline_overall: output/overall_counts_blt.csv
        baseline_table: output/blt_one_random_obs_perpat.csv

  describe_baseline_table_split_2019:
    run: r:latest analysis/tables/baseline_table_2019.R
    needs: [describe_basic_record_process]
    outputs:
      moderately_sensitive:
        baseline_overall_2019: output/overall_counts_blt_2019.csv
        baseline_table_2019: output/blt_one_random_obs_perpat_2019.csv

  describe_baseline_table_split_2020:
    run: r:latest analysis/tables/baseline_table_2020.R
    needs: [describe_basic_record_process]
    outputs:
      moderately_sensitive:
        baseline_overall_2020: output/overall_counts_blt_2020.csv
        baseline_table_2020: output/blt_one_random_obs_perpat_2020.csv

  describe_baseline_table_split_2021:
    run: r:latest analysis/tables/baseline_table_2021.R
    needs: [describe_basic_record_process]
    outputs:
      moderately_sensitive:
        baseline_overall_2021: output/overall_counts_blt_2021.csv
        baseline_table_2021: output/blt_one_random_obs_perpat_2021.csv
    
  describe_baseline_table_split_2022:
    run: r:latest analysis/tables/baseline_table_2022.R
    needs: [describe_basic_record_process]
    outputs:
      moderately_sensitive:
        baseline_overall_2022: output/overall_counts_blt_2022.csv
        baseline_table_2022: output/blt_one_random_obs_perpat_2022.csv

  # describe_consultation_rate:
  #   run: r:latest analysis/plot/incident_consultation_age_stacked_barchart.R
  #   needs: [generate_measures]
  #   outputs:
  #      moderately_sensitive:
  #       bar1: output/consult_age_UTI.png
  #       bar2: output/consult_age_LRTI.png
  #       bar3: output/consult_age_URTI.png
  #       bar4: output/consult_age_sinusitis.png
  #       bar5: output/consult_age_ot_externa.png
  #       bar6: output/consult_age_otmedia.png
  #       bar7: output/consult_age_repeatedUTI.png
       


  # describe_consultation_prescribed:
  #   run: r:latest analysis/plot/consultation_prescibed_percentage.R
  #   needs: [generate_study_population]
  #   outputs:
  #      moderately_sensitive:
  #       bar1: output/prescribed_percentage_UTI.png
  #       csvs: output/uti_prescrib_check.csv
     

  #generate_notebook_starpu:
  #  run: jupyter:latest jupyter nbconvert /workspace/analysis/starpu.ipynb --execute --to html --output-dir=/workspace/output/hospitalisation_risk --ExecutePreprocessor.timeout=86400
  #  needs: [generate_measures]
  #  outputs:
  #    moderately_sensitive:
  #      notebook: output/hospitalisation_risk/starpu.html 
  #      figures: output/hospitalisation_risk/*
        #tables: output/tables/*
        #csvs: output/*/* # two possible subfolders
        #text: output/text/*

  # generate_notebook_hospitalisation_analysis:
  #   run: jupyter:latest jupyter nbconvert /workspace/analysis/hospitalisation_analysis.ipynb --execute --to html --output-dir=/workspace/output/hospitalisation_risk --ExecutePreprocessor.timeout=86400
  #   needs: [generate_study_population]
  #   outputs:
  #   moderately_sensitive:
  #       notebook: output/hospitalisation_risk/hospitalisation_analysis.html 
  #       figures: output/hospitalisation_risk/*
    
  # generate_notebook_hospitalisation_analysis:
  #   run: jupyter:latest jupyter nbconvert /workspace/analysis/hospitalisation_analysis.ipynb --execute --to html --output-dir=/workspace/output/hospitalisation_risk --ExecutePreprocessor.timeout=86400
  #   needs: [generate_study_population]
  #   outputs:
  #     moderately_sensitive:
  #       notebook: output/hospitalisation_risk/hospitalisation_analysis.html 
  #       figures: output/hospitalisation_risk/*

  describe_prior_ab_12mb4:
    run: r:latest analysis/plot/ab_1yb4_stackedbar_2.R
    needs: [generate_study_population]
    outputs:
       moderately_sensitive:
        plot: output/AB_1yb4_line.jpeg
        plot_sex: output/AB_1yb4_SEX.jpeg
        #count_table: output/prior_ab_by_month.csv      


  describe_consultation_rate_all_incident:
    run: r:latest analysis/plot/consultation_by_age_infection_incident.R
    needs: [generate_measures_infection]
    outputs:
       moderately_sensitive:
        plot1.1: output/consult_age_incident_UTI.jpeg
        plot1.2: output/consult_age_incident_URTI.jpeg
        plot1.3: output/consult_age_incident_LRTI.jpeg
        plot1.4: output/consult_age_incident_sinusitis.jpeg
        plot1.5: output/consult_age_incident_otmedia.jpeg
        plot1.6: output/consult_age_incident_ot_externa.jpeg
        plot2: output/consult_all_incident.jpeg
        csv1: output/consultation_rate_incident.csv
        csv2: output/consultation_GP_rate_incident.csv
  
  describe_consultation_rate_all_prevalent:
    run: r:latest analysis/plot/consultation_by_age_infection_prevalent.R
    needs: [generate_measures_infection]
    outputs:
       moderately_sensitive:
        plot1.1: output/consult_age_prevalent_UTI.jpeg
        plot1.2: output/consult_age_prevalent_URTI.jpeg
        plot1.3: output/consult_age_prevalent_LRTI.jpeg
        plot1.4: output/consult_age_prevalent_sinusitis.jpeg
        plot1.5: output/consult_age_prevalent_otmedia.jpeg
        plot1.6: output/consult_age_prevalent_ot_externa.jpeg
        plot2: output/consult_all_prevalent.jpeg
        csv1: output/consultation_rate_prevalent.csv
        csv2: output/consultation_GP_rate_prevalent.csv

  describe_consultation_model_process_1:
    run: r:latest analysis/process/consultation_variables_1.R
    needs: [generate_measures_infection, describe_basic_record_process]
    outputs:
       moderately_sensitive:
        rds1: output/measures/consult_UTI.rds
        rds2: output/measures/consult_LRTI.rds
        rds3: output/measures/consult_URTI.rds
        rds4: output/measures/consult_sinusitis.rds
        rds5: output/measures/consult_otmedia.rds
        rds6: output/measures/consult_ot_externa.rds

  describe_consultation_model_process_2:
    run: r:latest analysis/process/consultation_variables_2.R
    needs: [describe_consultation_model_process_1]
    outputs:
       moderately_sensitive:
        rds1: output/measures/monthly_consult_UTI.rds
        rds2: output/measures/monthly_consult_LRTI.rds
        rds3: output/measures/monthly_consult_URTI.rds
        rds4: output/measures/monthly_consult_sinusitis.rds
        rds5: output/measures/monthly_consult_otmedia.rds
        rds6: output/measures/monthly_consult_ot_externa.rds
  
  describe_consultation_model_1:
    run: r:latest analysis/model/consult_model_1.R
    needs: [describe_consultation_model_process_2]
    outputs:
       moderately_sensitive:
        jpeg: output/consult_model1.jpeg
        rds: output/consult_model1.rds

  describe_consultation_model_2:
    run: r:latest analysis/model/consult_model_2.R
    needs: [describe_consultation_model_process_2]
    outputs:
       moderately_sensitive:
        jpeg: output/consult_model2.jpeg
        rds: output/consult_model2.rds
  
  # describe_consultation_model_3:
  #   run: r:latest analysis/model/consult_model_3.R
  #   needs: [describe_consultation_model_process_2]
  #   outputs:
  #      moderately_sensitive:
  #       jpeg: output/consult_model3.jpeg
  #       rds: output/consult_model3.rds

  # consultation_model: 
  #   run: r:latest -e 'rmarkdown::render("analysis/model/consultation_model.rmd", output_dir = "output/report")'
  #   needs: [describe_consultation_model_process_1]
  #   outputs:
  #     moderately_sensitive:
  #       html: output/report/consultation_model.html


  # check_consultation_model_uti: #  
  #   run: r:latest -e 'rmarkdown::render("analysis/process/report/check_consultation_model_uti.Rmd", output_dir = "output/report")'
  #   needs: [generate_measures_infection, describe_basic_record_process]
  #   outputs:
  #     moderately_sensitive:
  #       html: output/report/check_consultation_model_uti.html

  # check_consultation_model_urti: #  
  #   run: r:latest -e 'rmarkdown::render("analysis/process/report/check_consultation_model_urti.Rmd", output_dir = "output/report")'
  #   needs: [generate_measures_infection, describe_basic_record_process]
  #   outputs:
  #     moderately_sensitive:
  #       html: output/report/check_consultation_model_urti.html

  # check_consultation_model_lrti: #  
  #   run: r:latest -e 'rmarkdown::render("analysis/process/report/check_consultation_model_lrti.Rmd", output_dir = "output/report")'
  #   needs: [generate_measures_infection, describe_basic_record_process]
  #   outputs:
  #     moderately_sensitive:
  #       html: output/report/check_consultation_model_lrti.html

  # check_consultation_model_sinusitis: #  
  #   run: r:latest -e 'rmarkdown::render("analysis/process/report/check_consultation_model_sinusitis.Rmd", output_dir = "output/report")'
  #   needs: [generate_measures_infection, describe_basic_record_process]
  #   outputs:
  #     moderately_sensitive:
  #       html: output/report/check_consultation_model_sinusitis.html

  # check_consultation_model_ot_externa: #  
  #   run: r:latest -e 'rmarkdown::render("analysis/process/report/check_consultation_model_ot_externa.Rmd", output_dir = "output/report")'
  #   needs: [generate_measures_infection, describe_basic_record_process]
  #   outputs:
  #     moderately_sensitive:
  #       html: output/report/check_consultation_model_ot_externa.html

  # check_consultation_model_otmedia: #  
  #   run: r:latest -e 'rmarkdown::render("analysis/process/report/check_consultation_model_otmedia.Rmd", output_dir = "output/report")'
  #   needs: [generate_measures_infection, describe_basic_record_process]
  #   outputs:
  #     moderately_sensitive:
  #       html: output/report/check_consultation_model_otmedia.html


  # # describe_infection_prescribed_percent:
  # #   run: r:latest analysis/plot/infection_prescibed_percent.R
  # #   needs: [generate_measures_infection]
  # #   outputs:
  # #      moderately_sensitive:
  # #       plot1: output/infection_ab_precent_p1.jpeg
  # #       plot2: output/infection_ab_precent_p2.jpeg
  # #       plot3: output/infection_ab_precent_i1.jpeg
  # #       plot4: output/infection_ab_precent_i2.jpeg
  # #       plot5: output/infection_ab_precent_all.jpeg
  # #       csv1: output/prescribed_infection_prevalent.csv
  # #       csv2: output/prescribed_infection_incident.csv

  # # describe_top10ABtypes_byInfection:
  # #   run: r:latest analysis/plot/abtypes_top10.R
  # #   needs: [generate_measures_infection]
  # #   outputs:
  # #      moderately_sensitive:
  # #       plot1: output/abtype_UTI.jpeg
  # #       plot2: output/abtype_URTI.jpeg
  # #       plot3: output/abtype_LRTI.jpeg
  # #       plot4: output/abtype_sinusitis.jpeg
  # #       plot5: output/abtype_ot_externa.jpeg
  # #       plot6: output/abtype_otmedia.jpeg
  # #       plot7: output/abtype_percent_UTI.jpeg
  # #       plot8: output/abtype_percent_URTI.jpeg
  # #       plot9: output/abtype_percent_LRTI.jpeg
  # #       plot10: output/abtype_percent_sinusitis.jpeg
  # #       plot11: output/abtype_percent_ot_externa.jpeg
  # #       plot12: output/abtype_percent_otmedia.jpeg
  # #       csv: output/abtype_top10_by_infection.csv
  
  # # describe_top10ABtypes_byInfection_line:
  # #   run: r:latest analysis/plot/abtypes_top10_line.R
  # #   needs: [generate_measures_infection]
  # #   outputs:
  # #      moderately_sensitive:
  # #       plot13: output/abtype_UTI_line.jpeg
  # #       plot14: output/abtype_URTI_line.jpeg
  # #       plot15: output/abtype_LRTI_line.jpeg
  # #       plot16: output/abtype_sinusitis_line.jpeg
  # #       plot17: output/abtype_ot_externa_line.jpeg
  # #       plot18: output/abtype_otmedia_line.jpeg
  # #       plot19: output/abtype_percent_UTI_line.jpeg
  # #       plot20: output/abtype_percent_URTI_line.jpeg
  # #       plot21: output/abtype_percent_LRTI_line.jpeg
  # #       plot22: output/abtype_percent_sinusitis_line.jpeg
  # #       plot23: output/abtype_percent_ot_externa_line.jpeg
  # #       plot24: output/abtype_percent_otmedia_line.jpeg
  # #       csv: output/abtype_top10_by_infection_line.csv
  
  # describe_top10ABtypes_total:
  #   run: r:latest analysis/plot/types_ab_prescriptions.R
  #   needs: [generate_study_population]
  #   outputs:
  #      moderately_sensitive:
  #       plot1: output/abtype_all_Rx.jpeg
  #       plot2: output/abtype_all_Rx_percent.jpeg

  # describe_same_day_ab_sgss:
  #   run: r:latest analysis/plot/same_day_covid_ab_sgss.R
  #   needs: [generate_measures]
  #   outputs:
  #      moderately_sensitive:
  #       plot1: output/same_day_ab_prop_line_sgss_age.jpeg
  #       plot2: output/same_day_ab_prop_line_sgss.jpeg
  #       csv1: output/same_day_ab_prop_sgss.csv

  # describe_same_day_ab_gp:
  #   run: r:latest analysis/plot/same_day_covid_ab_gp.R
  #   needs: [generate_measures]
  #   outputs:
  #      moderately_sensitive:
  #       plot1: output/same_day_ab_prop_line_gp_age.jpeg
  #       plot2: output/same_day_ab_prop_line_gp.jpeg
  #       csv1: output/same_day_ab_prop_gp.csv

  generate_study_population_antibiotics: #  Antibiotics_recorded_01
    run: cohortextractor:latest generate_cohort --study-definition study_definition_antibiotics --index-date-range "2019-01-01 to today" --skip-existing --output-dir=output/measures --output-format=csv.gz
    outputs:
      highly_sensitive:
        cohort: output/measures/input_antibiotics_*.csv.gz

# used describe_ab_recoded_broad_process instead
  # describe_ab_recoded_indication_process: #  Antibiotics_recorded_02: generate prescription-level dataset 
  #   run: r:latest analysis/process/ab_recorded_indication_transform.R
  #   needs: [generate_study_population_antibiotics]
  #   outputs:
  #      highly_sensitive:
  #       rds1: output/measures/recorded_ab_2019.rds
  #       rds2: output/measures/recorded_ab_2020.rds
  #       rds3: output/measures/recorded_ab_2021.rds
  #       rds4: output/measures/recorded_ab_2022.rds
  
  describe_ab_recoded_indication_plot_incident: 
    run: r:latest analysis/plot/ab_recorded_indication_plot_incident.R
    needs: [describe_ab_recoded_broad_process] # transfrom & define all variables
    outputs:
       moderately_sensitive:
        plot1: output/ab_recorded_incident_bar.jpeg
        plot2: output/ab_recorded_incident_line.jpeg
        csv: output/ab_recorded_incident.csv

  describe_ab_recoded_indication_plot_prevalent: 
    run: r:latest analysis/plot/ab_recorded_indication_plot_prevalent.R
    needs: [describe_ab_recoded_broad_process]
    outputs:
       moderately_sensitive:
        plot1: output/ab_recorded_prevalent_bar.jpeg
        plot2: output/ab_recorded_prevalent_line.jpeg
        csv: output/ab_recorded_prevalent.csv
    
  describe_ab_recoded_broad_process:
    run: r:latest analysis/process/broad_transform.R
    needs: [generate_study_population_antibiotics]
    outputs:
       highly_sensitive:
        rds1: output/measures/recorded_ab_broad_2019.rds
        rds2: output/measures/recorded_ab_broad_2020.rds
        rds3: output/measures/recorded_ab_broad_2021.rds
        rds4: output/measures/recorded_ab_broad_2022.rds

  describe_broad_proportion:
    run: r:latest analysis/plot/broad_proportion.R
    needs: [describe_ab_recoded_broad_process]
    outputs:
       moderately_sensitive:
        plot: output/broad_proportions_line.jpeg
        table: output/broad_proportions.csv

  describe_basic_record_process:
    run: r:latest analysis/process/baseline_variables_transform.R
    needs: [generate_study_population]
    outputs:
       highly_sensitive:
        rds1: output/measures/basic_record_2019.rds
        rds2: output/measures/basic_record_2020.rds
        rds3: output/measures/basic_record_2021.rds
        rds4: output/measures/basic_record_2022.rds

  describe_check_broad_model_variable_2019:
    run: r:latest analysis/model/broad_variable_transform_2019.R
    needs: [describe_basic_record_process]
    outputs:
       highly_sensitive:
        rds1: output/measures/model_variable_broad_2019_1.rds

  describe_check_broad_model_variable_2019_2:
    run: r:latest analysis/model/charlson_transform_2019.R
    needs: [describe_basic_record_process]
    outputs:
       highly_sensitive:
        talbe1: output/model_varibale_table_charlson_2019.csv
        rds1: output/measures/model_variable_broad_2019_2.rds

  describe_check_broad_model_variable_2020:
    run: r:latest analysis/model/broad_variable_transform_2020.R
    needs: [describe_basic_record_process]
    outputs:
       highly_sensitive:
        rds1: output/measures/model_variable_broad_2020_1.rds

  describe_check_broad_model_variable_2020_2:
    run: r:latest analysis/model/charlson_transform_2020.R
    needs: [describe_basic_record_process]
    outputs:
       highly_sensitive:
        talbe1: output/model_varibale_table_charlson_2020.csv
        rds1: output/measures/model_variable_broad_2020_2.rds

  describe_check_broad_model_variable_2021:
    run: r:latest analysis/model/broad_variable_transform_2021.R
    needs: [describe_basic_record_process]
    outputs:
       highly_sensitive:
        rds1: output/measures/model_variable_broad_2021_1.rds

  describe_check_broad_model_variable_2021_2:
    run: r:latest analysis/model/charlson_transform_2021.R
    needs: [describe_basic_record_process]
    outputs:
       highly_sensitive:
        talbe1: output/model_varibale_table_charlson_2021.csv
        rds1: output/measures/model_variable_broad_2021_2.rds

  describe_check_broad_model_variable_2022:
    run: r:latest analysis/model/broad_variable_transform_2022.R
    needs: [describe_basic_record_process]
    outputs:
       highly_sensitive:
        rds1: output/measures/model_variable_broad_2022_1.rds

  describe_check_broad_model_variable_2022_2:
    run: r:latest analysis/model/charlson_transform_2022.R
    needs: [describe_basic_record_process]
    outputs:
       highly_sensitive:
        talbe1: output/model_varibale_table_charlson_2022.csv
        rds1: output/measures/model_variable_broad_2022_2.rds

  describe_broad_model_2019:   
    run: r:latest -e 'rmarkdown::render("analysis/model/broad_model_2019.Rmd", output_dir = "output/report")'
    needs: [describe_check_broad_model_variable_2019, describe_check_broad_model_variable_2019_2, describe_ab_recoded_broad_process]
    outputs:
      moderately_sensitive:
        html: output/report/broad_model_2019.html

  describe_broad_model_covid:   
    run: r:latest -e 'rmarkdown::render("analysis/model/broad_model_covid.Rmd", output_dir = "output/report")'
    needs: [describe_check_broad_model_variable_2020, describe_check_broad_model_variable_2020_2,
    describe_check_broad_model_variable_2021, describe_check_broad_model_variable_2021_2,
    describe_check_broad_model_variable_2022, describe_check_broad_model_variable_2022_2,
    describe_ab_recoded_broad_process]
    outputs:
      moderately_sensitive:
        html: output/report/broad_model_covid.html

  describe_descriptive_ab_broad:   
    run: r:latest -e 'rmarkdown::render("analysis/model/descriptive_ab_broad.Rmd", output_dir = "output/report")'
    needs: [generate_measures]
    outputs:
      moderately_sensitive:
        html: output/report/descriptive_ab_broad.html

  # describe_baseline_tb:   
  #   run: r:latest -e 'rmarkdown::render("analysis/model/baseline_table_pat_one.Rmd", output_dir = "output/report")'
  #   needs: [describe_check_broad_model_variable_2019, describe_check_broad_model_variable_2019_2,
  #   describe_check_broad_model_variable_2020, describe_check_broad_model_variable_2020_2,
  #   describe_check_broad_model_variable_2021, describe_check_broad_model_variable_2021_2,
  #   describe_check_broad_model_variable_2022, describe_check_broad_model_variable_2022_2]
  #   outputs:
  #     moderately_sensitive:
  #       html: output/report/baseline_table_pat_one.html
  
  describe_baseline_tb_2019:   
    run: r:latest -e 'rmarkdown::render("analysis/model/baseline_table_pat_one_2019.Rmd", output_dir = "output/report")'
    needs: [describe_check_broad_model_variable_2019, describe_check_broad_model_variable_2019_2]
    outputs:
      moderately_sensitive:
        html: output/report/baseline_table_pat_one_2019.html

  describe_baseline_tb_2020:   
    run: r:latest -e 'rmarkdown::render("analysis/model/baseline_table_pat_one_2020.Rmd", output_dir = "output/report")'
    needs: [describe_check_broad_model_variable_2020, describe_check_broad_model_variable_2020_2]
    outputs:
      moderately_sensitive:
        html: output/report/baseline_table_pat_one_2020.html

  describe_baseline_tb_2021:   
    run: r:latest -e 'rmarkdown::render("analysis/model/baseline_table_pat_one_2021.Rmd", output_dir = "output/report")'
    needs: [describe_check_broad_model_variable_2021, describe_check_broad_model_variable_2021_2]
    outputs:
      moderately_sensitive:
        html: output/report/baseline_table_pat_one_2021.html

  describe_baseline_tb_2022:   
    run: r:latest -e 'rmarkdown::render("analysis/model/baseline_table_pat_one_2022.Rmd", output_dir = "output/report")'
    needs: [describe_check_broad_model_variable_2022, describe_check_broad_model_variable_2022_2]
    outputs:
      moderately_sensitive:
        html: output/report/baseline_table_pat_one_2022.html


  # describe_ab_recoded_indication_process_plot: #  Antibiotics_recorded_02: only indication/row
  #   run: r:latest analysis/process/ab_recorded_indication_transform_plot.R
  #   needs: [generate_study_population_antibiotics]
  #   outputs:
  #      highly_sensitive:
  #       rds1: output/measures/recorded_ab_indication_2019.rds
  #       rds2: output/measures/recorded_ab_indication_2020.rds
  #       rds3: output/measures/recorded_ab_indication_2021.rds
  #       rds4: output/measures/recorded_ab_indication_2022.rds

  # describe_ab_recoded_indication_plot: 
  #   run: r:latest analysis/plot/ab_recorded_indication_plot.R
  #   needs: [describe_ab_recoded_indication_process_plot]
  #   outputs:
  #      highly_sensitive:
  #       plot1: output/ab_recorded_indication_bar.jpeg
  #       plot2: output/ab_recorded_indication_line.jpeg
  #       csv: output/ab_recorded_indication.csv

  generate_study_population_infection_abtype: # for ab types plot
    run: cohortextractor:latest generate_cohort --study-definition study_definition_infection_abtype --index-date-range "2019-01-01 to today by month" --skip-existing --output-dir=output/measures --output-format=csv.gz
    outputs:
      highly_sensitive:
        cohort: output/measures/input_infection_abtype_*.csv.gz
  
  describe_infection_abtype_process: #  infection/row
    run: r:latest analysis/process/infection_abtype_transform.R
    needs: [generate_study_population_infection_abtype]
    outputs:
       highly_sensitive:
        rds1: output/measures/abtype_uti.rds
        rds2: output/measures/abtype_lrti.rds
        rds3: output/measures/abtype_urti.rds
        rds4: output/measures/abtype_sinusitis.rds
        rds5: output/measures/abtype_ot_externa.rds
        rds6: output/measures/abtype_otmedia.rds

  describe_infection_abtype_plot: #  incident+prevalent
    run: r:latest analysis/plot/infection_abtype.R
    needs: [describe_infection_abtype_process]
    outputs:
       moderately_sensitive:
        plot1: output/abtype_uti.jpeg
        plot2: output/abtype_lrti.jpeg
        plot3: output/abtype_urti.jpeg
        plot4: output/abtype_sinusitis.jpeg
        plot5: output/abtype_ot_externa.jpeg
        plot6: output/abtype_otmedia.jpeg
        csv1: output/abtype_uti.csv
        csv2: output/abtype_lrti.csv
        csv3: output/abtype_urti.csv
        csv4: output/abtype_sinusitis.csv
        csv5: output/abtype_ot_externa.csv
        csv6: output/abtype_otmedia.csv
       
  
       