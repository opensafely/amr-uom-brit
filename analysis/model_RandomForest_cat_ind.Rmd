---
title: "Random Forest"
---

```{r setup, include=FALSE}
#library(knitr)
library(dplyr)
#library(skimr)
library('tidyverse')
library("ggplot2")
#library(caret)

knitr::opts_chunk$set(echo = TRUE)
options(knitr.table.format="html")

```

# import dataset
```{r }

#train_X <- read_rds("/Users/yayang/Documents/GitHub/amr-uom-brit/output/train_X.rds")
train_X <- read_rds(here::here("output","train_cat.rds"))
train_X$case=as.factor(train_X$case)
#col=c("patient_id","patient_index_date")
#train_X = subset(train_X, select = -c(patient_id, patient_index_date))

table(train_X$case)
prop.table(table(train_X$case))
train_X=train_X%>% group_by(subclass)%>% dplyr::mutate(rep.no=n()-1)#count control no. in subclass
train_X=train_X%>% ungroup(subclass)

train.1=train_X%>%filter(case==1)# filter case
train.1 <- as.data.frame(lapply(train.1, rep, train.1$rep.no-1))# duplicate case (6case:6control)
train_X=rbind(train.1,train_X) #merge

table(train_X$case)
prop.table(table(train_X$case))

rm(train.1)

saveRDS(train_X, here::here("output","train_6_cat.rds"))

```


```{r }

#valid_X <- read_rds("/Users/yayang/Documents/GitHub/amr-uom-brit/output/valid_X.rds")
valid_X <- read_rds(here::here("output","valid_cat.rds"))
valid_X$case=as.factor(valid_X$case)

table(valid_X$case)
prop.table(table(valid_X$case))
valid_X=valid_X%>% group_by(subclass)%>% dplyr::mutate(rep.no=n()-1)#count control no. in subclass
valid_X=valid_X%>% ungroup(subclass)

valid.1=valid_X%>%filter(case==1)# filter case
valid.1 <- as.data.frame(lapply(valid.1, rep, valid.1$rep.no-1))# duplicate case (6case:6control)
valid_X=rbind(valid.1,valid_X) #merge

table(valid_X$case)
prop.table(table(valid_X$case))

saveRDS(valid_X, here::here("output","valid_6_cat.rds"))


```


pick variable
```{r}
names(train_X)

#pred_col=c("patient_id","patient_index_date", "case","total_ab", "ab_prescriptions","ab_types","prescribe_times","exposure_period","recent_ab_days", "broad_prop" ,"broad_ab_prescriptions","interval_mean","interval_sd","interval_CV","length_mean", "length_sd", "length_CV","prescribe_time_0","prescribe_time_1","prescribe_time_2","prescribe_time_3",col,"AB_1_type","AB_6wk_type" ,"interval_med" ,"length_med" ,"ab_6w_binary" , "AB_6wk")

#abtype <- read_rds(here::here("output","abtype.rds"))
col=c("case","total_ab_group","ab_types_group",
      "exposure_period_group","recent_ab_days_group",
      "broad_ab_prescriptions_group",
      "interval_med_group" ,"interval_sd_group")
# abtype
train_X=train_X[col]
valid_X=valid_X[col]

str(train_X)
```


train model
# total_ab_group
```{r}
library(randomForest)

n=nrow(train_X)

set.seed(1024)
#for (i in 1:nrow(result)) {
  
  rf.model <- randomForest(formula = case ~ total_ab_group, data = train_X, 
                           replace = TRUE,
                           ntree =  1000,
                           sampsize = round(n*0.5),
                           nodesize = 100 ,
                           mtry = sqrt(ncol(train_X)-1)
                          )
  print(rf.model)
  
summary(predict(rf.model, type = 'prob')[,2])
```


# ab_types_group
```{r}
library(randomForest)

n=nrow(train_X)

set.seed(1024)
#for (i in 1:nrow(result)) {
  
  rf.model <- randomForest(formula = case ~ ab_types_group, data = train_X, 
                           replace = TRUE,
                           ntree =  1000,
                           sampsize = round(n*0.5),
                           nodesize = 100 ,
                           mtry = sqrt(ncol(train_X)-1)
                          )
  print(rf.model)
  
summary(predict(rf.model, type = 'prob')[,2])
```


# exposure_period_group
```{r}
library(randomForest)

n=nrow(train_X)

set.seed(1024)
#for (i in 1:nrow(result)) {
  
  rf.model <- randomForest(formula = case ~exposure_period_group, data = train_X, 
                           replace = TRUE,
                           ntree =  1000,
                           sampsize = round(n*0.5),
                           nodesize = 100 ,
                           mtry = sqrt(ncol(train_X)-1)
                          )
  print(rf.model)
  
summary(predict(rf.model, type = 'prob')[,2])
```

# recent_ab_days_group
```{r}
library(randomForest)

n=nrow(train_X)

set.seed(1024)
#for (i in 1:nrow(result)) {
  
  rf.model <- randomForest(formula = case ~recent_ab_days_group, data = train_X, 
                           replace = TRUE,
                           ntree =  1000,
                           sampsize = round(n*0.5),
                           nodesize = 100 ,
                           mtry = sqrt(ncol(train_X)-1)
                          )
  print(rf.model)
  
summary(predict(rf.model, type = 'prob')[,2])
```


# broad_ab_prescriptions_group
```{r}
library(randomForest)

n=nrow(train_X)

set.seed(1024)
#for (i in 1:nrow(result)) {
  
  rf.model <- randomForest(formula = case ~broad_ab_prescriptions_group, data = train_X, 
                           replace = TRUE,
                           ntree =  1000,
                           sampsize = round(n*0.5),
                           nodesize = 100 ,
                           mtry = sqrt(ncol(train_X)-1)
                          )
  print(rf.model)
  
summary(predict(rf.model, type = 'prob')[,2])
```

# interval_med_group
```{r}
library(randomForest)

n=nrow(train_X)

set.seed(1024)
#for (i in 1:nrow(result)) {
  
  rf.model <- randomForest(formula = case ~interval_med_group, data = train_X, 
                           replace = TRUE,
                           ntree =  1000,
                           sampsize = round(n*0.5),
                           nodesize = 100 ,
                           mtry = sqrt(ncol(train_X)-1)
                          )
  print(rf.model)
  
summary(predict(rf.model, type = 'prob')[,2])
```

# interval_sd_group
```{r}
library(randomForest)

n=nrow(train_X)

set.seed(1024)
#for (i in 1:nrow(result)) {
  
  rf.model <- randomForest(formula = case ~interval_sd_group, data = train_X, 
                           replace = TRUE,
                           ntree =  1000,
                           sampsize = round(n*0.5),
                           nodesize = 100 ,
                           mtry = sqrt(ncol(train_X)-1)
                          )
  print(rf.model)
  
summary(predict(rf.model, type = 'prob')[,2])
```