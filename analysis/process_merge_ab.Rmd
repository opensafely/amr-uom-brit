---
title: "merge monthly ab var"
author: "YT Y"
date: "07/04/2022"
output: 
  html_document:
   toc: true
   toc_depth: 2
   toc_float:
     collapsed: false
     smooth_scorll: false
---

```{r setup, include=FALSE}
library('tidyverse')
library("ggplot2")
library(knitr)
library(dplyr)
library(kableExtra)
knitr::opts_chunk$set(echo = TRUE)
options(knitr.table.format="html")


```


```{r}
setwd(here::here("output"))
#setwd('/Users/yayang/Documents/GitHub/amr-uom-brit/output')

# import matched patients dataset
df=read_rds("matched_outcome.rds")
df=df%>% select("patient_id","patient_index_date","age","sex","stp","case","subclass","total_ab")
count(df)

# year1 ab variables
#df1=read.csv(here::here("output","input_ab_yr1.csv"))
df1=read.csv("input_ab_yr1.csv")
str(df1)

#AB=colnames(df1[,8:139])
df1[,8:139]=df1[,8:139]%>%mutate_all(~replace(., is.na(.), 0)) # recode NA -> 0
df1[,8:139]<- sapply(df1[8:139],as.numeric)
df1$total_ab_yr1=rowSums(df1[,8:139])

str(df1)

df1=df1%>% select(-c("ab_first_date","ab_last_date","ab_prescriptions"))
names(df1)[138]<-"broad_ab_yr1"
count(df1)


# merge
DF=merge(df,df1,by=c("patient_id","patient_index_date","age","sex","stp"))
count(DF)

```

```{r}
# import ab var2
setwd(here::here("output"))
#setwd('/Users/yayang/Documents/GitHub/amr-uom-brit/output')

#df2=read.csv(here::here("output","input_ab_yr2.csv"))
df2=read.csv("input_ab_yr2.csv")

df2[,6:137]=df2[,6:137]%>%mutate_all(~replace(., is.na(.), 0)) # recode NA -> 0
df2[,6:137]<- sapply(df2[,6:137],as.numeric)
df2$total_ab_yr2=rowSums(df2[,6:137])

names(df2)[138]<-"broad_ab_yr2"
count(df2)


# merge
DF=merge(DF,df2,by=c("patient_id","patient_index_date","age","sex","stp"))
count(DF)

```

```{r}
# import ab var3
setwd(here::here("output"))
#setwd('/Users/yayang/Documents/GitHub/amr-uom-brit/output')

#df3=read.csv(here::here("output","input_ab_yr3.csv"))
df3=read.csv("input_ab_yr3.csv")

df3[,6:137]=df3[,6:137]%>%mutate_all(~replace(., is.na(.), 0)) # recode NA -> 0
df3[,6:137]<- sapply(df3[,6:137],as.numeric)
df3$total_ab_yr3=rowSums(df3[,6:137])

names(df3)[138]<-"broad_ab_yr3"
count(df3)


# merge
DF=merge(DF,df3,by=c("patient_id","patient_index_date","age","sex","stp"))
count(DF)

write_rds(DF,"matched_patients_monthly_ab.rds")
```

