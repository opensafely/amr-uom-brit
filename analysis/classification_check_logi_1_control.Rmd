---
title: "classification comparison: logistic"
---

```{r setup, include=FALSE}
library("survival")
library('tidyverse')
library(pROC)# plyr
library(randomForest)#dplyr
```

# import dataset
```{r }
train <- read_rds(here::here("output","train_X.rds"))
valid <- read_rds(here::here("output","valid_X.rds"))

table(train$case)
table(valid$case)
```

# separate dataset: random one control
```{r }
set.seed(123)
train=train%>%group_by(case, subclass)%>%sample_n(1)
valid=valid%>%group_by(case, subclass)%>%sample_n(1)

table(train$case)
table(valid$case)

train=train%>%ungroup(case,subclass)
valid=valid%>%ungroup(case,subclass)

```


# pick variable and create decile groups
```{r}
names(train)
col=c("case","subclass","total_ab","ab_types",
      "prescribe_time_0","prescribe_time_1","prescribe_time_2","prescribe_time_3",
      "exposure_period","recent_ab_days",
      "broad_ab_prescriptions","broad_prop",
      "interval_med" ,"interval_mean","interval_CV","interval_sd",
      "length_med","length_mean","length_CV","length_sd")


train=train[col]
```


# decile group
```{r}
for (k in 3:20) {

decile_value=quantile(train[,k],c(0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1))
  
train[,k+18]=NA

for (i in 1:9) {
train[,k+18]=ifelse(train[,k] > decile_value[i] & train[,k]<=decile_value[i+1],i+1,train[,k+18])  
}
  
train[,k+18]=ifelse(train[,k] <= decile_value[1],1,train[,k+18])

colnames(train)[k+18]=paste0(col[3],"_decile")

prop.table(table(train[,k+18]))
}
```


# total ab
## logistic regression
```{r}
library(MASS)

train$case=as.numeric(as.character(train$case))
rf.model=glm(case~total_ab_decile_decile_decile,family="binomial",x=TRUE,y=TRUE,data = train)
print(rf.model)
```

## model performance
### train
```{r}
# probabilities of cases
pred.y <- predict(rf.model, train, type = 'response')

#  c statistic / AUC
roc_train <- roc(train$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_train) #AUC


# E/O
O <- prop.table(table(train$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(train,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% dplyr::group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(train$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(train$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")
```



### valid
```{r}
# probabilities of cases
pred.y <- predict(rf.model, valid, type = 'response')

#  c statistic / AUC
roc_valid <- roc(valid$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_valid) #AUC


# E/O
O <- prop.table(table(valid$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(valid,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(valid$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(valid$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")

```






# ab_types
## logistic regression
```{r}
library(MASS)

train$case=as.numeric(as.character(train$case))
rf.model=glm(case~ab_types_decile_decile,family="binomial",x=TRUE,y=TRUE,data = train)
print(rf.model)
```

## model performance
### train
```{r}
# probabilities of cases
pred.y <- predict(rf.model, train, type = 'response')

#  c statistic / AUC
roc_train <- roc(train$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_train) #AUC


# E/O
O <- prop.table(table(train$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(train,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% dplyr::group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(train$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(train$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")
```



### valid
```{r}
# probabilities of cases
pred.y <- predict(rf.model, valid, type = 'response')

#  c statistic / AUC
roc_valid <- roc(valid$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_valid) #AUC


# E/O
O <- prop.table(table(valid$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(valid,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(valid$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(valid$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")

```





# exposure_period
## logistic regression
```{r}
library(MASS)

train$case=as.numeric(as.character(train$case))
rf.model=glm(case~exposure_period_decile_decile,family="binomial",x=TRUE,y=TRUE,data = train)
print(rf.model)
```

## model performance
### train
```{r}
# probabilities of cases
pred.y <- predict(rf.model, train, type = 'response')

#  c statistic / AUC
roc_train <- roc(train$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_train) #AUC


# E/O
O <- prop.table(table(train$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(train,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% dplyr::group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(train$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(train$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")
```



### valid
```{r}
# probabilities of cases
pred.y <- predict(rf.model, valid, type = 'response')

#  c statistic / AUC
roc_valid <- roc(valid$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_valid) #AUC


# E/O
O <- prop.table(table(valid$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(valid,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(valid$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(valid$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")

```







# recent_ab_days
## logistic regression
```{r}
library(MASS)

train$case=as.numeric(as.character(train$case))
rf.model=glm(case~recent_ab_days_decile_decile,family="binomial",x=TRUE,y=TRUE,data = train)
print(rf.model)
```

## model performance
### train
```{r}
# probabilities of cases
pred.y <- predict(rf.model, train, type = 'response')

#  c statistic / AUC
roc_train <- roc(train$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_train) #AUC


# E/O
O <- prop.table(table(train$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(train,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% dplyr::group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(train$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(train$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")
```



### valid
```{r}
# probabilities of cases
pred.y <- predict(rf.model, valid, type = 'response')

#  c statistic / AUC
roc_valid <- roc(valid$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_valid) #AUC


# E/O
O <- prop.table(table(valid$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(valid,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(valid$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(valid$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")

```






# broad_ab_prescriptions
## logistic regression
```{r}
library(MASS)

train$case=as.numeric(as.character(train$case))
rf.model=glm(case~broad_ab_prescriptions_decile_decile,family="binomial",x=TRUE,y=TRUE,data = train)
print(rf.model)
```

## model performance
### train
```{r}
# probabilities of cases
pred.y <- predict(rf.model, train, type = 'response')

#  c statistic / AUC
roc_train <- roc(train$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_train) #AUC


# E/O
O <- prop.table(table(train$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(train,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% dplyr::group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(train$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(train$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")
```



### valid
```{r}
# probabilities of cases
pred.y <- predict(rf.model, valid, type = 'response')

#  c statistic / AUC
roc_valid <- roc(valid$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_valid) #AUC


# E/O
O <- prop.table(table(valid$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(valid,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(valid$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(valid$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")

```





# broad_prop
## logistic regression
```{r}
library(MASS)

train$case=as.numeric(as.character(train$case))
rf.model=glm(case~broad_prop_decile_decile,family="binomial",x=TRUE,y=TRUE,data = train)
print(rf.model)
```

## model performance
### train
```{r}
# probabilities of cases
pred.y <- predict(rf.model, train, type = 'response')

#  c statistic / AUC
roc_train <- roc(train$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_train) #AUC


# E/O
O <- prop.table(table(train$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(train,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% dplyr::group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(train$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(train$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")
```



### valid
```{r}
# probabilities of cases
pred.y <- predict(rf.model, valid, type = 'response')

#  c statistic / AUC
roc_valid <- roc(valid$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_valid) #AUC


# E/O
O <- prop.table(table(valid$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(valid,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(valid$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(valid$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")

```




# interval_med
## logistic regression
```{r}
library(MASS)

train$case=as.numeric(as.character(train$case))
rf.model=glm(case~interval_med_decile,family="binomial",x=TRUE,y=TRUE,data = train)
print(rf.model)
```

## model performance
### train
```{r}
# probabilities of cases
pred.y <- predict(rf.model, train, type = 'response')

#  c statistic / AUC
roc_train <- roc(train$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_train) #AUC


# E/O
O <- prop.table(table(train$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(train,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% dplyr::group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(train$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(train$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")
```



### valid
```{r}
# probabilities of cases
pred.y <- predict(rf.model, valid, type = 'response')

#  c statistic / AUC
roc_valid <- roc(valid$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_valid) #AUC


# E/O
O <- prop.table(table(valid$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(valid,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(valid$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(valid$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")

```



# interval_mean
## logistic regression
```{r}
library(MASS)

train$case=as.numeric(as.character(train$case))
rf.model=glm(case~interval_mean_decile,family="binomial",x=TRUE,y=TRUE,data = train)
print(rf.model)
```

## model performance
### train
```{r}
# probabilities of cases
pred.y <- predict(rf.model, train, type = 'response')

#  c statistic / AUC
roc_train <- roc(train$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_train) #AUC


# E/O
O <- prop.table(table(train$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(train,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% dplyr::group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(train$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(train$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")
```



### valid
```{r}
# probabilities of cases
pred.y <- predict(rf.model, valid, type = 'response')

#  c statistic / AUC
roc_valid <- roc(valid$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_valid) #AUC


# E/O
O <- prop.table(table(valid$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(valid,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(valid$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(valid$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")

```




# interval_CV
## logistic regression
```{r}
library(MASS)

train$case=as.numeric(as.character(train$case))
rf.model=glm(case~interval_CV_decile,family="binomial",x=TRUE,y=TRUE,data = train)
print(rf.model)
```

## model performance
### train
```{r}
# probabilities of cases
pred.y <- predict(rf.model, train, type = 'response')

#  c statistic / AUC
roc_train <- roc(train$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_train) #AUC


# E/O
O <- prop.table(table(train$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(train,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% dplyr::group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(train$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(train$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")
```



### valid
```{r}
# probabilities of cases
pred.y <- predict(rf.model, valid, type = 'response')

#  c statistic / AUC
roc_valid <- roc(valid$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_valid) #AUC


# E/O
O <- prop.table(table(valid$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(valid,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(valid$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(valid$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")

```





# interval_sd
## logistic regression
```{r}
library(MASS)

train$case=as.numeric(as.character(train$case))
rf.model=glm(case~interval_sd_decile,family="binomial",x=TRUE,y=TRUE,data = train)
print(rf.model)
```

## model performance
### train
```{r}
# probabilities of cases
pred.y <- predict(rf.model, train, type = 'response')

#  c statistic / AUC
roc_train <- roc(train$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_train) #AUC


# E/O
O <- prop.table(table(train$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(train,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% dplyr::group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(train$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(train$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")
```



### valid
```{r}
# probabilities of cases
pred.y <- predict(rf.model, valid, type = 'response')

#  c statistic / AUC
roc_valid <- roc(valid$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_valid) #AUC


# E/O
O <- prop.table(table(valid$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(valid,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(valid$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(valid$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")

```







# length_med
## logistic regression
```{r}
library(MASS)

train$case=as.numeric(as.character(train$case))
rf.model=glm(case~length_med_decile,family="binomial",x=TRUE,y=TRUE,data = train)
print(rf.model)
```

## model performance
### train
```{r}
# probabilities of cases
pred.y <- predict(rf.model, train, type = 'response')

#  c statistic / AUC
roc_train <- roc(train$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_train) #AUC


# E/O
O <- prop.table(table(train$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(train,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% dplyr::group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(train$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(train$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")
```



### valid
```{r}
# probabilities of cases
pred.y <- predict(rf.model, valid, type = 'response')

#  c statistic / AUC
roc_valid <- roc(valid$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_valid) #AUC


# E/O
O <- prop.table(table(valid$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(valid,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(valid$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(valid$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")

```







# length_mean
## logistic regression
```{r}
library(MASS)

train$case=as.numeric(as.character(train$case))
rf.model=glm(case~length_mean_decile,family="binomial",x=TRUE,y=TRUE,data = train)
print(rf.model)
```

## model performance
### train
```{r}
# probabilities of cases
pred.y <- predict(rf.model, train, type = 'response')

#  c statistic / AUC
roc_train <- roc(train$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_train) #AUC


# E/O
O <- prop.table(table(train$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(train,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% dplyr::group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(train$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(train$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")
```



### valid
```{r}
# probabilities of cases
pred.y <- predict(rf.model, valid, type = 'response')

#  c statistic / AUC
roc_valid <- roc(valid$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_valid) #AUC


# E/O
O <- prop.table(table(valid$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(valid,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(valid$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(valid$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")

```







# length_CV
## logistic regression
```{r}
library(MASS)

train$case=as.numeric(as.character(train$case))
rf.model=glm(case~length_CV_decile,family="binomial",x=TRUE,y=TRUE,data = train)
print(rf.model)
```

## model performance
### train
```{r}
# probabilities of cases
pred.y <- predict(rf.model, train, type = 'response')

#  c statistic / AUC
roc_train <- roc(train$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_train) #AUC


# E/O
O <- prop.table(table(train$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(train,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% dplyr::group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(train$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(train$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")
```



### valid
```{r}
# probabilities of cases
pred.y <- predict(rf.model, valid, type = 'response')

#  c statistic / AUC
roc_valid <- roc(valid$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_valid) #AUC


# E/O
O <- prop.table(table(valid$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(valid,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(valid$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(valid$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")

```






# length_sd
## logistic regression
```{r}
library(MASS)

train$case=as.numeric(as.character(train$case))
rf.model=glm(case~length_sd_decile,family="binomial",x=TRUE,y=TRUE,data = train)
print(rf.model)
```

## model performance
### train
```{r}
# probabilities of cases
pred.y <- predict(rf.model, train, type = 'response')

#  c statistic / AUC
roc_train <- roc(train$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_train) #AUC


# E/O
O <- prop.table(table(train$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(train,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% dplyr::group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(train$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(train$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")
```



### valid
```{r}
# probabilities of cases
pred.y <- predict(rf.model, valid, type = 'response')

#  c statistic / AUC
roc_valid <- roc(valid$case ~ pred.y, smoothed = TRUE,
            ci=TRUE, ci.alpha=0.9, stratified=FALSE,
            plot=TRUE, auc.polygon=TRUE, max.auc.polygon=TRUE, grid=TRUE,
            print.auc=TRUE, show.thres=TRUE)
print(roc_valid) #AUC


# E/O
O <- prop.table(table(valid$case))[2]
E <- mean(pred.y)
E/O
```

#### create decile group of risk probability
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(pred.y,(i/10),na.rm=T)
}

vec# decile value

groups=pred.y # vector to fill in
groups=ifelse(pred.y <=vec[1],1,groups)

for (i in 1:9) {
groups=ifelse(groups >vec[i] & groups <=vec[i+1],i+1,groups)  
}

table(groups)
prop.table(table(groups))*100 # % decile

```

```{r}
# calibration 

# average the observed and expected probabilities of patients in each risk group 
gpdata <- cbind(valid,groups,pred.y)

obs=gpdata%>%group_by(groups)%>%dplyr::summarise(mean.obs=mean(as.numeric(as.character(case))))
obs=obs%>% pull(mean.obs)
#obs <- (ddply(gpdata,~groups,summarise,mean=mean(as.numeric(as.character(case))))[,2])
exp=gpdata%>% group_by(groups)%>% dplyr::summarise(mean.exp=mean(pred.y))
exp=exp%>%pull(mean.exp)
#exp <- ddply(gpdata,~groups,summarise,mean=mean(pred.y))
obsn <- table(valid$case,groups)[1,] 

cbind(exp,obs)# expected value vs. observed value
 
# CIs for scatter points
lci = pmax(0,(obs - (1.96*(((obs*(1-obs))/obsn)^.5))))
uci = pmin(1,(obs+ (1.96*(((obs*(1-obs))/obsn)^.5))))

# graph a simple calibration plot over 10 risk groups
par(pty="s")
plot(obs~exp,xlim=c(0,1),ylim=c(0,1),col="red",ylab="Observed",xlab="Expected")
lines(c(0,1),c(0,1),lty=2)

for(i in 1:10){
lines(c(exp[i],exp[i]),c(lci[i],uci[i]),col="green")
}

h <- hist(pred.y, breaks=50, plot=FALSE)
for(i in 1:length(h$mids)){
  lines(c(h$mids[i],h$mids[i]),c(rep(1,length(h$mids))[i],1-((h$counts[i]/max(h$counts))/10)))
}

# Add a loess smoother to the plot
obs_all <- predict(loess(as.numeric(as.character(valid$case))~pred.y,span=1))
lines_data <- data.frame(pred.y,obs_all)
lines_data2 <- lines_data[order(pred.y),] 
lines(lines_data2[,1],lines_data2[,2],col="blue")
legend(0.0,0.9,c("Risk groups","Reference line","95% CI","Loess"),col=c("red","black","green","blue"),lty=c(0,2,1,1),pch=c(1,NA,NA,NA),bty="n")

```









