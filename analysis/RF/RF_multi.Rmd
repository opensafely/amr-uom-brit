---
title: "Random Forest model_"
---

```{r setup, include=FALSE}
library(dplyr)
library('tidyverse')
library(pROC)
library(randomForest)

```

# train and valid dataset (matched)
```{r }
train_X <- read_rds(here::here("output","train_cat.rds"))
train_X$case=as.factor(train_X$case)
valid_X <- read_rds(here::here("output","valid_cat.rds"))
valid_X$case=as.factor(valid_X$case)

#names(train_X)
```

## compare patient number 
```{r}

nrow(train_X)# train patients (matched)
table(train_X$case)# total train patients
prop.table(table(train_X$case))# % train patients

nrow(valid_X)# valid patients(matched)
table(valid_X$case)# total valid patients
prop.table(table(valid_X$case))# % valid patients
```


pick variable
```{r}
names(train_X)


col=c("case","total_ab_group","ab_types_group",
      "exposure_period_group","recent_ab_days_group",
      "broad_ab_prescriptions_group",
    "interval_mean_group","interval_sd_group")
# abtype
train_X=train_X[col]
valid_X=valid_X[col]

str(train_X)
```

# RF
```{r}
library(randomForest)

n=nrow(train_X)

set.seed(1024)
#for (i in 1:nrow(result)) {
  
  rf.model <- randomForest(formula = case ~ ., data = train_X, 
                           replace = TRUE,
                           ntree =  1000,
                           sampsize = round(n*0.5),
                           nodesize = 100 ,
                           mtry = 3
                          )
  print(rf.model)
```



# development set
## predict probabilities 
```{r}
data=train_X

prob <- predict(rf.model, type = 'prob')[,2]# votes of being case

summary(prob)
hist(prob)
sum(prob==0)/length(prob)# % zero

#exp.class <- predict(rf.model, data, type = 'response')# predicted case/control
#prop.table(summary(exp.class))
```

## create decile group
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(prob,(i/10),na.rm=T)
}

vec# decile value

decile=vector()
decile=ifelse(prob <=vec[1],1,decile)

for (i in 1:9) {
decile=ifelse(prob >vec[i] & prob <=vec[i+1],i+1,decile )  
}


table(decile)
prop.table(table(decile))*100 

```

## combine columns
```{r}
head(decile)
head(prob)

newdata <- cbind(data,decile,prob)

str(newdata)
```

## check non-antibiotics users%
```{r}
for (i in 1:10) {
  
  print(paste0("decile=",i))
  print(summary(newdata[decile==i,]$total_ab))

}
```


## check decile distribution
```{r}
for (i in 1:10) {
  
  print(paste0("decile=",i))
  print(summary(newdata[decile==i,]$prob))

}
nrow(newdata)

development=newdata
rm(newdata)
rm(data)
```



# validation set
## predict probabilities 
```{r}
data=valid_X

prob <- predict(rf.model, data, type = 'prob')[,2]# votes of being case

summary(prob)
hist(prob)
sum(prob==0)/length(prob)# % zero

#exp.class <- predict(rf.model, data, type = 'response')# predicted case/control
#prop.table(summary(exp.class))
```

## create decile group
```{r}

vec=vector()

for (i in 1:10){
  vec[i]=quantile(prob,(i/10),na.rm=T)
}

vec# decile value

decile=vector()
decile=ifelse(prob <=vec[1],1,decile)

for (i in 1:9) {
decile=ifelse(prob >vec[i] & prob <=vec[i+1],i+1,decile )  
}


table(decile)
prop.table(table(decile))*100 # % decile
```

## combine columns
```{r}
head(decile)
head(prob)

newdata <- cbind(data,decile,prob)
str(newdata)
```

## check non-antibiotics users%
```{r}
for (i in 1:10) {
  
  print(paste0("decile=",i))
  print(summary(newdata[decile==i,]$total_ab))

}
```

## check decile distribution
```{r}
for (i in 1:10) {
  
  print(paste0("decile=",i))
  print(summary(newdata[decile==i,]$prob))

}
nrow(newdata)

validation=newdata
rm(newdata)
rm(data)
```


```{r}
nrow(development)
nrow(validation)
```


```{r}
saveRDS(development,here::here("output","development.rds"))
saveRDS(validation,here::here("output","validation.rds"))

str(development)
```

