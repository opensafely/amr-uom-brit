---
title: " Descriptive stat of RF classification"
---

```{r setup, include=FALSE}
library('tidyverse')
library("ggplot2")
library("plyr")
library('dplyr')
library('lubridate')
library('stringr')
library("data.table")
library("ggpubr")
library("finalfit")
```




# variable importance
## https://brunaw.com/slides/rladies-dublin/RF/intro-to-rf.html#30
```{r}
model_rf=readRDS(here::here("output","RF_model_ranger.rds"))


# calculate relative importance
imps <- data.frame(var = names(model_rf$variable.importance),
                   imps = model_rf$variable.importance/max(model_rf$variable.importance),
                   imps.score=model_rf$variable.importance)

# rename variable
imps$var
imps$var=c("Total antibiotics","Antibiotic types","Exposure period","Recent exposure", "Broad-spectrum antibiotics","Prescribing intervals (mean)", "Prescribing intervals (SD)")
```


```{r}
# importance plot
imps %>% 
  ggplot(aes(imps, x = reorder(var, imps))) +
  geom_point(size = 3, colour = "grey60") +
  coord_flip() +
  labs(x = "", y = "Importance") +
  theme_bw(15)

imps %>% 
  ggplot(aes(imps.score, x = reorder(var, imps.score))) +
  geom_point(size = 3, colour = "grey60", ) +
  coord_flip() +
  labs(x = "", y = "Importance Score") +
  theme_bw(15)
```

# read table
```{r}
data=read_rds(here::here("output","all_ranger.rds"))
data$decile=as.factor(data$decile)
```



# descriptive stat
```{r}
contd<- c("total_ab","ab_types","exposure_period","recent_ab_days","broad_ab_prescriptions","interval_mean","interval_sd")
```


```{r}

temp.list=list()

for (i in 1:7) {
  
Q1=tapply(data[,contd[i]],data[,"decile"], quantile, p=0.25)  
Q3=tapply(data[,contd[i]],data[,"decile"], quantile, p=0.75)  
Q2=tapply(data[,contd[i]],data[,"decile"], quantile, p=0.5)  
mean=tapply(data[,contd[i]],data[,"decile"], mean)  

temp.tbl= data.frame(Q1,Q3,Q2,mean)
temp.tbl$variable=contd[i]
temp.list[[i]]<- temp.tbl

}

table=rbindlist(temp.list)

table

write.csv(table,here::here("output","input_range.csv"))

```


# categorised ab exposure variables
```{r}
col=c("case","subclass",
  "total_ab","ab_types","prescribe_times",
         "exposure_period","recent_ab_days", 
         "broad_prop","broad_ab_prescriptions",
         "interval_mean","interval_med" ,"interval_sd","interval_CV",
         "length_mean","length_med", "length_sd","length_CV")

data=data %>% mutate_at(col,as.numeric)
names(data)

for (k in 3:17) {

cut_value=quantile(data[,col[k]],c(0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1))
print(cut_value)
  
data[,paste0(col[k],"_group")]=ifelse(
  data[,col[k]] <= cut_value[1],1,NA)  

data[,paste0(col[k],"_group")]=ifelse(
  data[,col[k]] > cut_value[1] & data[,col[k]]<= cut_value[2],2, 
  data[,paste0(col[k],"_group")])  

data[,paste0(col[k],"_group")]=ifelse(
  data[,col[k]] > cut_value[2] & data[,col[k]]<= cut_value[3],3, 
  data[,paste0(col[k],"_group")])  

data[,paste0(col[k],"_group")]=ifelse(
  data[,col[k]] > cut_value[3] & data[,col[k]]<= cut_value[4],4, 
  data[,paste0(col[k],"_group")])  

data[,paste0(col[k],"_group")]=ifelse(
  data[,col[k]] > cut_value[4] & data[,col[k]]<= cut_value[5],5, 
  data[,paste0(col[k],"_group")])  

data[,paste0(col[k],"_group")]=ifelse(
  data[,col[k]] > cut_value[5] & data[,col[k]]<= cut_value[6],6, 
  data[,paste0(col[k],"_group")])  

data[,paste0(col[k],"_group")]=ifelse(
  data[,col[k]] > cut_value[6] & data[,col[k]]<= cut_value[7],7, 
  data[,paste0(col[k],"_group")])  

data[,paste0(col[k],"_group")]=ifelse(
  data[,col[k]] > cut_value[7] & data[,col[k]]<= cut_value[8],8, 
  data[,paste0(col[k],"_group")])  

data[,paste0(col[k],"_group")]=ifelse(
  data[,col[k]] > cut_value[8] & data[,col[k]]<= cut_value[9],9, 
  data[,paste0(col[k],"_group")])  

data[,paste0(col[k],"_group")]=ifelse(
  data[,col[k]] > cut_value[3],10,data[,paste0(col[k],"_group")])  

data[,paste0(col[k],"_group")]=ifelse(
 is.na( data[,col[k]]) ,0 ,data[,paste0(col[k],"_group")])  



}

data$total_ab_group=relevel(as.factor(data$total_ab_group),ref= "1")
data$ab_types_group=relevel(as.factor(data$ab_types_group),ref= "1")
data$exposure_period_group=relevel(as.factor(data$exposure_period_group),ref= "1")
data$recent_ab_days_group=relevel(as.factor(data$recent_ab_days_group),ref= "1")
data$broad_prop_group=relevel(as.factor(data$broad_prop_group),ref= "1")
data$broad_ab_prescriptions_group=relevel(as.factor(data$broad_ab_prescriptions_group),ref= "1")
data$interval_mean_group=relevel(as.factor(data$interval_mean_group),ref= "1")
data$interval_med_group=relevel(as.factor(data$interval_med_group),ref= "1")
data$interval_CV_group=relevel(as.factor(data$interval_CV_group),ref= "1")
data$interval_sd_group=relevel(as.factor(data$interval_sd_group),ref= "1")
data$length_med_group=relevel(as.factor(data$length_med_group),ref= "1")
data$length_mean_group=relevel(as.factor(data$length_mean_group),ref= "1")
data$length_CV_group=relevel(as.factor(data$length_CV_group),ref= "1")
data$length_sd_group=relevel(as.factor(data$length_sd_group),ref= "1")

prop.table(table(data$total_ab_group))
prop.table(table(data$ab_types_group))
prop.table(table(data$exposure_period_group))
prop.table(table(data$recent_ab_days_group))
prop.table(table(data$broad_ab_prescriptions_group))
prop.table(table(data$interval_med_group))
prop.table(table(data$interval_sd_group))

```


