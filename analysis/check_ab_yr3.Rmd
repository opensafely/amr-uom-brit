---
title: "AB in recent 1 year"
output: 
  html_document:
   toc: true
   toc_depth: 2
   toc_float:
     collapsed: false
     smooth_scorll: false
---

```{r setup, include=FALSE}
library('tidyverse')
library("ggplot2")
library('dplyr')
library('lubridate')

knitr::opts_chunk$set(echo = TRUE)
options(knitr.table.format="html")
```


```{r}

#setwd(here::here("output"))
#setwd("/Users/yayang/Documents/GitHub/amr-uom-brit/output")
# read variables and add "case"
df_ab_extraction=read.csv("input_ab_yr1.csv")

count(df_ab_extraction)

## add variables to extracted cohort:"subclass","case", 
df_matched <- read_rds("matched_patients.rds")
df_matched= df_matched%>%select(c("patient_id","sex","stp","subclass","case","patient_index_date"))

count(df_matched)
#df=merge(DF1,DF2,by=c("patient_id","age","sex","stp"),all.x=T) can't merge with dummy data
df=merge(df_matched,df_ab_extraction,by=c("patient_id","sex","stp","patient_index_date"),all=T)
rm(df_matched,df_ab_extraction)

count(df)
```

```{r}
df1=df%>%filter(case==1)
df0=df%>%filter(case==0)
# random 1 control
df0=df%>% group_by(subclass)%>%sample_n(1)
df0=ungroup(df0)

df=rbind(df1,df0)
count(df1)
count(df0)
count(df)
```


```{r}
AB_name=c("Amoxicillin","Azithromycin","Cefalexin","Ciprofloxacin","Clarithromycin","Co_amoxiclav","Doxycycline","Flucloxacillin","Nitrofurantoin","Phenoxymethylpenicillin","Trimethoprim")

DF_case=data_frame()
for (i in 1:12){
 for (j in 1:11){
   DF_case[i,j]=sum(df1[paste0("Rx_",i,"_",AB_name[j])])
  }
}
colnames(DF_case)=AB_name
```

```{r}

DF_control=data_frame()
for (i in 1:12){
  for (j in 1:11){
    DF_control[i,j]=sum(df0[paste0("Rx_",i,"_",AB_name[j])])
  }
}
colnames(DF_control)=AB_name
```

```{r}

DF_case=DF_case%>% gather()
DF_case$month=rep(1:12,11)

DF_control=gather(DF_control)
DF_control$month=rep(1:12,11)

DF_case$case=1
DF_control$case=0

DF=rbind(DF_case,DF_control)
barplot(DF)

DF$case=as.factor(DF$case)
DF$month=as.factor(DF$month)




```

```{r}
for (i in 1:11){

DF_ab=DF%>%filter(key==AB_name[i])
print(
ggplot(data=DF_ab, aes(x=month, y=value, fill=case)) +
  geom_col(position="dodge", stat="identity")
)
}

```

