---
title: "antibiotics variables check"
output: 
  html_document:
   toc: true
   toc_depth: 2
   toc_float:
     collapsed: false
     smooth_scorll: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r packages, include=FALSE}
require('tidyverse')
require("gtsummary")
require("ggplot2")
library("survival")
library(car)
```








```{r include=FALSE}
# import data
rm(list=ls())
#df=read_rds("/Users/yayang/Documents/GitHub/amr-uom-brit/output/matched_outcome.rds")
df <- read_rds(here::here("output","matched_outcome.rds"))

```


# AB quintile by total ab

```{r}
### 1.1-ab quintile = according to unique ab prescription numbers
df$total_ab=ifelse(df$total_ab==0,NA,df$total_ab) # filter no ab

ggplot(df, aes(x=total_ab)) +
  geom_bar(aes(y = ..prop..))

summary(df$total_ab)

df$ab_prescriptions=ifelse(df$total_ab==0,NA,df$total_ab) # filter no ab

df$total_ab=ifelse(df$total_ab==0,NA,df$total_ab) # filter no ab
#qn_num=unique(df$total_ab)
qn_cat1=quantile(df$total_ab,0.2,na.rm=T)
qn_cat2=quantile(df$total_ab,0.4,na.rm=T)
qn_cat3=quantile(df$total_ab,0.6,na.rm=T)
qn_cat4=quantile(df$total_ab,0.8,na.rm=T)

qn_cat1 #1
qn_cat2 #1
qn_cat3 #2
qn_cat4 #4


df$level=ifelse(df$total_ab==qn_cat1,1,NA)
df$level=ifelse(df$total_ab >qn_cat1 & df$total_ab <=qn_cat3,2,df$level)
df$level=ifelse(df$total_ab >qn_cat3 & df$total_ab <=qn_cat4,3,df$level)
df$level=ifelse(df$total_ab >qn_cat4,4,df$level)


table(df$level)

summary(df[df$level==1,]$total_ab)
summary(df[df$level==2,]$total_ab)
summary(df[df$level==3,]$total_ab)
summary(df[df$level==4,]$total_ab)

```


```{r}

# outcome
df$case=as.numeric(df$case) #1/0

df$subclass=as.factor(df$subclass)#pair id

# matched variables
df$ab_qn=as.character(df$ab_qn) #category
df$ab_types=as.integer(df$ab_types)

df$br_ab_qn=as.character(df$br_ab_qn)




```

```{r}
# dummy data
#df[1:15,5]<-1
 #df[16:29,5]<-0
#df[1:15,4]<-seq(1:15)
 #df[16:29,4]<-seq(1:14)
```

# compare total vs. ab_presc

## cross table : total vs. ab_prescriptions
```{r}
table(df$total_ab_qn_5,df$ab_qn_5)
prop.table(table(df$total_ab_qn_5,df$ab_qn_5),margin=1)*100
```

```{r}
table(df$total_ab_qn,df$ab_qn)
prop.table(table(df$total_ab_qn,df$ab_qn),margin=1)*100
```



# abtypes

## continuous variable
### ab prescriptions
```{r}

ggplot(df, aes(x=ab_types)) +
  geom_bar(aes(y = ..prop..))+
  facet_grid(ab_qn~case)

table(df$ab_qn,df$ab_types)
prop.table(table(df$ab_qn,df$ab_types),margin=1)*100
```

```{r}

ggplot(df, aes(x=ab_types)) +
  geom_bar(aes(y = ..prop..))+
  facet_grid(ab_qn_5~case)

table(df$ab_qn_5,df$ab_types)
prop.table(table(df$ab_qn_5,df$ab_types),margin=1)*100
```

### total ab
```{r}

ggplot(df, aes(x=ab_types)) +
  geom_bar(aes(y = ..prop..))+
  facet_grid(total_ab_qn~case)

table(df$total_ab_qn,df$ab_types)
prop.table(table(df$total_ab_qn,df$ab_types),margin=1)*100
```


```{r}

ggplot(df, aes(x=ab_types)) +
  geom_bar(aes(y = ..prop..))+
  facet_grid(total_ab_qn_5~case)

table(df$total_ab_qn_5,df$ab_types)
prop.table(table(df$total_ab_qn_5,df$ab_types),margin=1)*100
```


## categorical variable

### ab prescriptions ab_qn
```{r}
#df=df%>%mutate(abtype_3=ntile(ab_types,3))

df=df%>%mutate(abtype_3=case_when( ab_types==0 ~ "0",
               ab_types>0 & ab_types<=3 ~"1",
               ab_types>3 & ab_types<=6 ~"2",
               ab_types>6 & ab_types<=9 ~"3"))

summary(df[df$abtype_3=="1",]$ab_types)
summary(df[df$abtype_3=="2",]$ab_types)
summary(df[df$abtype_3=="3",]$ab_types)


table(df$ab_qn,df$abtype_3)
prop.table(table(df$ab_qn,df$abtype_3),margin=1)*100

ggplot(df, aes(x=abtype_3)) +
  geom_bar()+
  facet_grid(ab_qn~case)


```


### ab prescriptions- ab_qn_5
```{r}
#df=df%>%mutate(abtype_3=ntile(ab_types,3))

table(df$ab_qn_5,df$abtype_3)
prop.table(table(df$ab_qn_5,df$abtype_3),margin=1)*100

ggplot(df, aes(x=abtype_3)) +
  geom_bar()+
  facet_grid(ab_qn_5~case)

```

### total- total_ab_qn
```{r}
#df=df%>%mutate(abtype_3=ntile(ab_types,3))

table(df$total_ab_qn,df$abtype_3)
prop.table(table(df$total_ab_qn,df$abtype_3),margin=1)*100

```

### total- total_ab_qn_5
```{r}
#df=df%>%mutate(abtype_3=ntile(ab_types,3))

table(df$total_ab_qn_5,df$abtype_3)
prop.table(table(df$total_ab_qn_5,df$abtype_3),margin=1)*100


```




## categorical variable- ab_qn
```{r}
#df=df%>%mutate(abtype_3=ntile(ab_types,3))

df=df%>%mutate(abtype_3=case_when( ab_types==0 ~ "0",
               ab_types>0 & ab_types<=3 ~"1",
               ab_types>3 & ab_types<=6 ~"2",
               ab_types>6 & ab_types<=9 ~"3"))

summary(df[df$abtype_3=="1",]$ab_types)
summary(df[df$abtype_3=="2",]$ab_types)
summary(df[df$abtype_3=="3",]$ab_types)


table(df$ab_qn,df$abtype_3)
prop.table(table(df$ab_qn,df$abtype_3),margin=1)*100

ggplot(df, aes(x=abtype_3)) +
  geom_bar()+
  facet_grid(ab_qn~case)


```


## categorical variable- ab_qn_5
```{r}
#df=df%>%mutate(abtype_3=ntile(ab_types,3))

table(df$ab_qn_5,df$abtype_3)
prop.table(table(df$ab_qn_5,df$abtype_3),margin=1)*100

ggplot(df, aes(x=abtype_3)) +
  geom_bar()+
  facet_grid(ab_qn_5~case)


```



# broad ab qn 5
## ab_qn
```{r}

ggplot(df, aes(x=br_ab_qn_5)) +
  geom_bar()+
  facet_grid(ab_qn~case)
table(df$ab_qn,df$br_ab_qn_5)
prop.table(table(df$ab_qn,df$br_ab_qn_5),margin=1)*100
```

## ab_qn_5
```{r}

ggplot(df, aes(x=br_ab_qn_5)) +
  geom_bar()+
  facet_grid(ab_qn_5~case)
table(df$ab_qn_5,df$br_ab_qn_5)
prop.table(table(df$ab_qn_5,df$br_ab_qn_5),margin=1)*100

```

## total_ab_qn
```{r}

ggplot(df, aes(x=br_ab_qn_5)) +
  geom_bar()+
  facet_grid(total_ab_qn~case)
table(df$total_ab_qn,df$br_ab_qn_5)
prop.table(table(df$total_ab_qn,df$br_ab_qn_5),margin=1)*100
```

## total_ab_qn_5
```{r}

ggplot(df, aes(x=br_ab_qn_5)) +
  geom_bar()+
  facet_grid(total_ab_qn_5~case)
table(df$total_ab_qn_5,df$br_ab_qn_5)
prop.table(table(df$total_ab_qn_5,df$br_ab_qn_5),margin=1)*100

```

# broad total ab qn 5
## ab_qn
```{r}

ggplot(df, aes(x=br_total_ab_qn_5)) +
  geom_bar()+
  facet_grid(ab_qn~case)
table(df$ab_qn,df$br_total_ab_qn_5)
prop.table(table(df$ab_qn,df$br_total_ab_qn_5),margin=1)*100
```

## ab_qn_5
```{r}

ggplot(df, aes(x=br_total_ab_qn_5)) +
  geom_bar()+
  facet_grid(ab_qn_5~case)
table(df$ab_qn_5,df$br_total_ab_qn_5)
prop.table(table(df$ab_qn_5,df$br_total_ab_qn_5),margin=1)*100

```

## total_ab_qn
```{r}

ggplot(df, aes(x=br_total_ab_qn_5)) +
  geom_bar()+
  facet_grid(total_ab_qn~case)
table(df$total_ab_qn,df$br_total_ab_qn_5)
prop.table(table(df$total_ab_qn,df$br_total_ab_qn_5),margin=1)*100
```

## total_ab_qn_5
```{r}

ggplot(df, aes(x=br_total_ab_qn_5)) +
  geom_bar()+
  facet_grid(total_ab_qn_5~case)
table(df$total_ab_qn_5,df$br_total_ab_qn_5)
prop.table(table(df$total_ab_qn_5,df$br_total_ab_qn_5),margin=1)*100

```


# models
## ab type
```{r}

#mod=clogit(case ~ ab_qn + ab_types + CCI + covrx_ever + strata(subclass), df)
#summary(mod)
#vif(mod)
```

## br_ab
```{r}
#mod=clogit(case ~ ab_qn +br_ab_qn + ab_qn*br_ab_qn + CCI + covrx_ever + strata(subclass), df)
#summary(mod)
#vif(mod)
```


