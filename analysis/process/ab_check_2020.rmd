---
title: "AB check"
output: 
  html_document:
   toc: true
   toc_depth: 2
   toc_float:
     collapsed: false
     smooth_scorll: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
knitr::opts_knit$set(root.dir = '/workspace')
```

```{r echo=TRUE}
library("tidyverse") 
library('dplyr')#conflict with plyr; load after plyr
library('lubridate')

rm(list=ls())

#setwd(here::here("output", "measures"))

# file list
csvFiles_19 = list.files(path=here::here("output","measures"),pattern="input_infection_abtype_2019", full.names = FALSE)

# date list
date_19= seq(as.Date("2019-01-01"), as.Date("2019-12-01"), "month")

# variables names list
prevalent_check=paste0("hx_ab_uti_date_",rep(1:4))#prevalent check
ab_category=paste0("uti_abtype",rep(1:4))#ab type
infec_date=paste0("uti_date_",rep(1:4)) #infection records


# read columns
col_spec <-cols_only( patient_id = 'd',
                    
                      uti_abtype1 = 'c',
                      uti_abtype2 = 'c',
                      uti_abtype3 = 'c',
                      uti_abtype4 = 'c',
                      
                      hx_ab_uti_date_1 ='d',
                      hx_ab_uti_date_2 ='d',
                      hx_ab_uti_date_3 ='d',
                      hx_ab_uti_date_4 ='d',
                      
                      uti_date_1 = 'd',
                      uti_date_2 = 'd',
                      uti_date_3 = 'd',
                      uti_date_4 = 'd',
                      
                      age = 'd',
                      sex = 'c'
                     )
                    



# transform dataset & create list 2019
i=1
  # read in one-month data
  df <- read_csv(csvFiles_19[i],
                 col_types = col_spec, na="" )
  #### patient/row --> infection consultqtion/row
  
  length(unique(as.factor(df$patient_id)))
  # filter all antibiotics users
  df=df%>%filter(!is.na(uti_date_1))
  
  
  length(unique(as.factor(df$patient_id)))

  
  # prevalent_AB_date
  df1=df%>%select(patient_id,age,sex,all_of(prevalent_check))
  colnames(df1)[4:7]=paste0("time",rep(1:4))
  df1.1=df1%>%gather(times,prevalent,paste0("time",rep(1:4)))
  rm(df1)
  
  # ab_category 
  df2=df%>%select(patient_id,age,sex,all_of(ab_category))
  colnames(df2)[4:7]=paste0("time",rep(1:4))
  df2.1=df2%>%gather(times,abtype,paste0("time",rep(1:4)))
  rm(df2)
  
  # infection date
  df3=df%>%select(patient_id,age,sex,all_of(infec_date))
  colnames(df3)[4:7]=paste0("time",rep(1:4))
  df3.1=df3%>%gather(times,date,paste0("time",rep(1:4)))
  
  # merge
  DF=merge(df1.1,df2.1,by=c("patient_id","age","sex","times"))
  DF=merge(DF,df3.1,by=c("patient_id","age","sex","times"))

  DF=DF%>%filter(!is.na(date)) # has infection date means has infection
  
  count(DF)






```

