---
title: "conditional logistic regression"
---

```{r setup, include=FALSE}
library(knitr)
library(dplyr)
library('tidyverse')
```

# covid hospitalisation
```{r}
DF1=readRDS(here::here("output","matched_outcome.rds"))
nrow(DF1)
table(DF1$case)
prop.table(table(DF1$case))
DF1$set=1

summary(DF1$total_ab)
```


# in hospital death
```{r}
DF2=readRDS(here::here("output","matched_outcome_hosp.rds"))
nrow(DF2)
table(DF2$case)
prop.table(table(DF2$case))
DF2$set=2
summary(DF2$total_ab)
```

# general patients
```{r}
DF3=readRDS(here::here("output","matched_outcome_general.rds"))
nrow(DF3)
table(DF3$case)
prop.table(table(DF3$case))
DF3$set=3

summary(DF3$total_ab)
DF=rbind(DF1,DF2,DF3)
```

# remove outlier
```{r eval=FALSE, include=FALSE}


outlier=quantile(DF$total_ab,0.9999)
outlier

DF=DF%>% filter(total_ab < outlier)
nrow(DF[DF$set==1,])
nrow(DF[DF$set==2,])
nrow(DF[DF$set==3,])

DF=DF%>% filter(total_ab >1)
nrow(DF[DF$set==1,])
nrow(DF[DF$set==2,])
nrow(DF[DF$set==3,])


DF$case=as.numeric(DF$case)
# delet controls if case is removed
DF=DF%>%group_by(set,subclass)%>%mutate(keep=sum(case))
DF=DF%>%filter(keep==1)
nrow(DF[DF$set==1,])
nrow(DF[DF$set==2,])
nrow(DF[DF$set==3,])

```


## covid hospitalisation
### create quintile ab group
```{r}
DF1=DF%>%filter(set==1)

vec=vector()

for (i in 1:5){
  vec[i]=quantile(DF1$total_ab,(i/5),na.rm=T)
}

vec# decile value

DF1$quintile=NA
DF1$quintile=ifelse(DF1$total_ab <=vec[1],1,DF1$quintile)

for (i in 1:5) {
DF1$quintile=ifelse(DF1$total_ab >vec[i] & DF1$total_ab <=vec[i+1],i+1,DF1$quintile )  
}


table(DF1$quintile)
prop.table(table(DF1$quintile))*100 


```

```{r}
nrow(DF1)
table(DF1$case)
prop.table(table(DF1$case))

#table(DF1$case,DF1$quintile)
#prop.table(table(DF1$case,DF1$quintile))

table(DF1$case,DF1$quintile)
summary(DF1$total_ab)

saveRDS(DF1,here::here("output","study_2.rds"))
rm(DF1)
```



# in hospital death
### create quintile ab group
```{r}
DF2=DF%>%filter(set==2)

vec=vector()

for (i in 1:5){
  vec[i]=quantile(DF2$total_ab,(i/5),na.rm=T)
}

vec# decile value

DF2$quintile=NA
DF2$quintile=ifelse(DF2$total_ab <=vec[1],1,DF2$quintile)

for (i in 1:5) {
DF2$quintile=ifelse(DF2$total_ab >vec[i] & DF2$total_ab <=vec[i+1],i+1,DF2$quintile )  
}


table(DF2$quintile)
prop.table(table(DF2$quintile))*100 

```

```{r}
nrow(DF2)
table(DF2$case)
prop.table(table(DF2$case))

table(DF2$case,DF2$quintile)

summary(DF2$total_ab)


saveRDS(DF2,here::here("output","study_3.rds"))
rm(DF2)

```




# general patients

### create quintile ab group
```{r}
DF3=DF%>%filter(set==3)

vec=vector()

for (i in 1:5){
  vec[i]=quantile(DF3$total_ab,(i/5),na.rm=T)
}

vec# decile value

DF3$quintile=NA
DF3$quintile=ifelse(DF3$total_ab <=vec[1],1,DF3$quintile)

for (i in 1:5) {
DF3$quintile=ifelse(DF3$total_ab >vec[i] & DF3$total_ab <=vec[i+1],i+1,DF3$quintile )  
}


table(DF3$quintile)
prop.table(table(DF3$quintile))*100 


```

```{r}
nrow(DF3)
table(DF3$case)
prop.table(table(DF3$case))


table(DF3$case,DF3$quintile)


summary(DF3$total_ab)


saveRDS(DF3,here::here("output","study_1.rds"))

```
