---
title: "Input Data Check"
output: 
  html_document:
   toc: true
   toc_depth: 2
   toc_float:
     collapsed: false
     smooth_scorll: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r , include=FALSE}
require('tidyverse')
require("gtsummary")
require("ggplot2")
```

# cohort extractor

## study_population_covid_hosp
###### patient_index_date range
```{r}
dat=read_csv(here::here("output","input_covid_admission.csv"),
             col_types=cols_only(
               age=col_double(),
               sex=col_character(),
               patient_index_date=col_date()
             ))

range(dat$patient_index_date, na.rm=T)

dat$patient_index_date=ifelse(is.na(dat$patient_index_date),NA,1)

dat %>%
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{min}, {max}",
      all_categorical() ~ "{n} ({p}%)"))
rm(dat)
```


#  define case and control
## case_1: covid death/icu
###### patient_index_date range
```{r}
dat=read_csv(here::here("output","case_covid_icu_death.csv"),
             col_types=cols_only(
               age=col_double(),
               sex=col_character(),
               patient_index_date=col_date()
             ))

range(dat$patient_index_date, na.rm=T)

dat$patient_index_date=ifelse(is.na(dat$patient_index_date),NA,1)

dat %>%
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{min}, {max}",
      all_categorical() ~ "{n} ({p}%)"))
rm(list=ls())
```

## control_1: no covid death/icu
###### patient_index_date range
```{r}
dat=read_csv(here::here("output","control_covid_hosp.csv"),
             col_types=cols_only(
               age=col_double(),
               sex=col_character(),
               patient_index_date=col_date()
             ))

range(dat$patient_index_date, na.rm=T)

dat$patient_index_date=ifelse(is.na(dat$patient_index_date),NA,1)

dat %>%
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{min}, {max}",
      all_categorical() ~ "{n} ({p}%)"))
rm(list=ls())
```


## case_2: any death/ covid icu
###### patient_index_date range
```{r}
dat=read_csv(here::here("output","case_covid_icu_death_2.csv"),
             col_types=cols_only(
               age=col_double(),
               sex=col_character(),
               patient_index_date=col_date()
             ))

range(dat$patient_index_date, na.rm=T)

dat$patient_index_date=ifelse(is.na(dat$patient_index_date),NA,1)

dat %>%
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{min}, {max}",
      all_categorical() ~ "{n} ({p}%)"))
rm(list=ls())
```

## control_2: no any death/icu
###### patient_index_date range
```{r}
dat=read_csv(here::here("output","control_covid_hosp_2.csv"),
             col_types=cols_only(
               age=col_double(),
               sex=col_character(),
               patient_index_date=col_date()
             ))

range(dat$patient_index_date, na.rm=T)

dat$patient_index_date=ifelse(is.na(dat$patient_index_date),NA,1)

dat %>%
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{min}, {max}",
      all_categorical() ~ "{n} ({p}%)"))
rm(list=ls())
```



# matching with replacement
## matching 1
###### patient_index_date range
```{r}
dat=read_rds(here::here("output","matched_patients.rds"))
dat=dat%>%select(age,sex,patient_index_date)
range(dat$patient_index_date, na.rm=T)

dat %>%
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{min}, {max}",
      all_categorical() ~ "{n} ({p}%)"))
rm(list=ls())
```

# matching with replacement
## matching 2
###### patient_index_date range
```{r}
dat=read_rds(here::here("output","matched_patients_2.rds"))
dat=dat%>%select(age,sex,patient_index_date)
range(dat$patient_index_date, na.rm=T)

dat %>%
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{min}, {max}",
      all_categorical() ~ "{n} ({p}%)"))
rm(list=ls())
```


#  extract variables
## extraction 1
###### patient_index_date range
```{r}
dat=read_csv(here::here("output","input_outcome.csv"),
             col_types=cols_only(
               age=col_double(),
               sex=col_character(),
               patient_index_date=col_date()
             ))

range(dat$patient_index_date, na.rm=T)



dat %>%
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{min}, {max}",
      all_categorical() ~ "{n} ({p}%)"))
rm(list=ls())
```

## extraction 2
###### patient_index_date range
```{r}
dat=read_csv(here::here("output","input_outcome2.csv"),
             col_types=cols_only(
               age=col_double(),
               sex=col_character(),
               patient_index_date=col_date()
             ))

range(dat$patient_index_date, na.rm=T)



dat %>%
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{min}, {max}",
      all_categorical() ~ "{n} ({p}%)"))
rm(list=ls())
```

#  sort variables
## process_matching 1
###### patient_index_date range
```{r}
dat=read_rds(here::here("output","matched_outcome.rds"))
dat=dat%>%select(age,sex,patient_index_date)

range(dat$patient_index_date, na.rm=T)

dat %>%
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{min}, {max}",
      all_categorical() ~ "{n} ({p}%)"))
rm(list=ls())
```

## process_matching 2
###### patient_index_date range
```{r}
dat=read_rds(here::here("output","matched_outcome2.rds"))
dat=dat%>%select(age,sex,patient_index_date)

range(dat$patient_index_date, na.rm=T)

dat %>%
  tbl_summary(
    statistic = list(
      all_continuous() ~ "{min}, {max}",
      all_categorical() ~ "{n} ({p}%)"))
rm(list=ls())
```


