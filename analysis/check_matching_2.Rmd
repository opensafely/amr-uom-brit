---
title: "Matching Report 2"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r packages, include=FALSE}
require('tidyverse')
require("gtsummary")
require("ggplot2")
```

# <font color=blue>**1:6 matching**</font>
```{r include=FALSE}
# import data
rm(list=ls())
df <- read_csv(here::here("output","matched_combined_infection_hosp_6.csv"))
#df= read.csv("/Users/yayang/Documents/GitHub/amr-uom-brit/output/matched_combined_infection_hosp_6.csv")
```


```{r include=FALSE}
# number of patients in case group
num.case=length(unique(df[df$case=="1",]$patient_id))
```

#### Cases: COVID hospital admission / **count:`r num.case`**

```{r include=FALSE}
# number of patients in control group
num.contr=length(unique(df[df$case=="0",]$patient_id))
```

#### Controls: COVID infection /  **count:`r num.contr`**

***

# Matched pairs 
#### *1:6 matching by age (within 5 years), sex, region (stp)*

**number of matched controls per case**
```{r echo=FALSE }

control=subset(df,df$case=="0")
control=control%>%group_by(set_id)%>%summarise(num.matches=n())

# number of matched controls per case
table(control$num.matches)
# proportional of matched controls per case
round(prop.table(table(control$num.matches)),digits=2)
```



### Distribution of Age

##### **Figure 1: age distribution **

This plot shows the age distribution of matched study population by outcome groups. Group averages are shown as dashed lines.
```{r  echo=FALSE }
df.sub <- df %>% select(patient_id, case, set_id, age, sex, stp)
df.sub$case=as.factor(df.sub$case)
# calculate mean of age in both case and control groups
df.sub=df.sub%>%group_by(case)%>%mutate(grp.mean= mean(age))

ggplot(df.sub, aes(x=age, fill=case, color=case)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.1,bins=30)+
  geom_density(alpha=0.5)+
  geom_vline(data=df.sub, aes(xintercept=grp.mean, color=case),
             linetype="dashed")+
  scale_x_continuous(breaks = seq(0, 110, by=10))

```

##### **Figure 2: age distribution by numbers of matches**

```{r  echo=FALSE }
df.sub=df.sub%>%group_by(case,set_id)%>%mutate(num.matches=n())
df.sub=df.sub%>%group_by(case,num.matches)%>%mutate( matches.mean=mean(age))
df.sub$num.matches=as.factor(df.sub$num.matches)

df.sub.contr=subset(df.sub, case=="0")
df.sub.case=subset(df.sub, case=="1")

ggplot(df.sub.contr, aes(x=age)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.5,bins=30)+
  geom_density(alpha=0.5)+
  geom_vline(data=df.sub.contr, aes(xintercept= matches.mean),
             linetype="dashed")+
  scale_x_continuous(breaks = seq(0, 110, by=20))+
  labs(title="Control groups by number of matches")+
  facet_grid(num.matches ~.)

ggplot(df.sub.case, aes(x=age)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.5,bins=30)+
  geom_density(alpha=0.5)+
  geom_vline(data=df.sub.case, aes(xintercept= matches.mean),
             linetype="dashed")+
  scale_x_continuous(breaks = seq(0, 110, by=20))+
  labs(title="Case group")

```

##### **Figure 3: distribution of mean age in matched pairs**
control: group mean by set_id
case: mean
```{r  echo=FALSE }

df.sub.set=df.sub%>%group_by(case,set_id)%>% summarise(m.age.setid= mean(age)) # matches only count once
df.sub.set=df.sub.set%>%group_by(case)%>%mutate(grp.mean.setid= mean(m.age.setid))

ggplot(df.sub.set, aes(x=m.age.setid, fill=case, color=case)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.1,bins=30)+
  geom_density(alpha=0.5)+
  geom_vline(data=df.sub.set, aes(xintercept=grp.mean.setid, color=case),
             linetype="dashed")+
  scale_x_continuous(breaks = seq(0, 110, by=10))

```



# <font color=blue>**1:4 matching**</font>
```{r include=FALSE}
# import data
rm(list=ls())
df <- read_csv(here::here("output","matched_combined_infection_hosp_4.csv"))
#df= read.csv("/Users/yayang/Documents/GitHub/amr-uom-brit/output/matched_combined_infection_hosp_6.csv")
```


```{r include=FALSE}
# number of patients in case group
num.case=length(unique(df[df$case=="1",]$patient_id))
```

#### Cases: COVID hospital admission / **count:`r num.case`**

```{r include=FALSE}
# number of patients in control group
num.contr=length(unique(df[df$case=="0",]$patient_id))
```

#### Controls: COVID infection /  **count:`r num.contr`**

***

# Matched pairs 
#### *1:4 matching by age (within 5 years), sex, region (stp)*

**number of matched controls per case**
```{r echo=FALSE }

control=subset(df,df$case=="0")
control=control%>%group_by(set_id)%>%summarise(num.matches=n())

# number of matched controls per case
table(control$num.matches)
# proportional of matched controls per case
round(prop.table(table(control$num.matches)),digits=2)
```



### Distribution of Age

##### **Figure 1: age distribution **

This plot shows the age distribution of matched study population by outcome groups. Group averages are shown as dashed lines.
```{r  echo=FALSE }
df.sub <- df %>% select(patient_id, case, set_id, age, sex, stp)
df.sub$case=as.factor(df.sub$case)
# calculate mean of age in both case and control groups
df.sub=df.sub%>%group_by(case)%>%mutate(grp.mean= mean(age))

ggplot(df.sub, aes(x=age, fill=case, color=case)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.1,bins=30)+
  geom_density(alpha=0.5)+
  geom_vline(data=df.sub, aes(xintercept=grp.mean, color=case),
             linetype="dashed")+
  scale_x_continuous(breaks = seq(0, 110, by=10))

```

##### **Figure 2: age distribution by numbers of matches**

```{r  echo=FALSE }
df.sub=df.sub%>%group_by(case,set_id)%>%mutate(num.matches=n())
df.sub=df.sub%>%group_by(case,num.matches)%>%mutate( matches.mean=mean(age))
df.sub$num.matches=as.factor(df.sub$num.matches)

df.sub.contr=subset(df.sub, case=="0")
df.sub.case=subset(df.sub, case=="1")

ggplot(df.sub.contr, aes(x=age)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.5,bins=30)+
  geom_density(alpha=0.5)+
  geom_vline(data=df.sub.contr, aes(xintercept= matches.mean),
             linetype="dashed")+
  scale_x_continuous(breaks = seq(0, 110, by=20))+
  labs(title="Control groups by number of matches")+
  facet_grid(num.matches ~.)

ggplot(df.sub.case, aes(x=age)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.5,bins=30)+
  geom_density(alpha=0.5)+
  geom_vline(data=df.sub.case, aes(xintercept= matches.mean),
             linetype="dashed")+
  scale_x_continuous(breaks = seq(0, 110, by=20))+
  labs(title="Case group")

```

##### **Figure 3: distribution of mean age in matched pairs**
control: group mean by set_id
case: mean
```{r  echo=FALSE }

df.sub.set=df.sub%>%group_by(case,set_id)%>% summarise(m.age.setid= mean(age)) # matches only count once
df.sub.set=df.sub.set%>%group_by(case)%>%mutate(grp.mean.setid= mean(m.age.setid))

ggplot(df.sub.set, aes(x=m.age.setid, fill=case, color=case)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.1,bins=30)+
  geom_density(alpha=0.5)+
  geom_vline(data=df.sub.set, aes(xintercept=grp.mean.setid, color=case),
             linetype="dashed")+
  scale_x_continuous(breaks = seq(0, 110, by=10))

```



# <font color=blue>**1:2 matching**</font>
```{r include=FALSE}
# import data
rm(list=ls())
df <- read_csv(here::here("output","matched_combined_infection_hosp_2.csv"))
#df= read.csv("/Users/yayang/Documents/GitHub/amr-uom-brit/output/matched_combined_infection_hosp_6.csv")
```


```{r include=FALSE}
# number of patients in case group
num.case=length(unique(df[df$case=="1",]$patient_id))
```

#### Cases: COVID hospital admission / **count:`r num.case`**

```{r include=FALSE}
# number of patients in control group
num.contr=length(unique(df[df$case=="0",]$patient_id))
```

#### Controls: COVID infection /  **count:`r num.contr`**

***

# Matched pairs 
#### *1:2 matching by age (within 5 years), sex, region (stp)*

**number of matched controls per case**
```{r echo=FALSE }

control=subset(df,df$case=="0")
control=control%>%group_by(set_id)%>%summarise(num.matches=n())

# number of matched controls per case
table(control$num.matches)
# proportional of matched controls per case
round(prop.table(table(control$num.matches)),digits=2)
```



### Distribution of Age

##### **Figure 1: age distribution **

This plot shows the age distribution of matched study population by outcome groups. Group averages are shown as dashed lines.
```{r  echo=FALSE }
df.sub <- df %>% select(patient_id, case, set_id, age, sex, stp)
df.sub$case=as.factor(df.sub$case)
# calculate mean of age in both case and control groups
df.sub=df.sub%>%group_by(case)%>%mutate(grp.mean= mean(age))

ggplot(df.sub, aes(x=age, fill=case, color=case)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.1,bins=30)+
  geom_density(alpha=0.5)+
  geom_vline(data=df.sub, aes(xintercept=grp.mean, color=case),
             linetype="dashed")+
  scale_x_continuous(breaks = seq(0, 110, by=10))

```

##### **Figure 2: age distribution by numbers of matches**

```{r  echo=FALSE }
df.sub=df.sub%>%group_by(case,set_id)%>%mutate(num.matches=n())
df.sub=df.sub%>%group_by(case,num.matches)%>%mutate( matches.mean=mean(age))
df.sub$num.matches=as.factor(df.sub$num.matches)

df.sub.contr=subset(df.sub, case=="0")
df.sub.case=subset(df.sub, case=="1")

ggplot(df.sub.contr, aes(x=age)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.5,bins=30)+
  geom_density(alpha=0.5)+
  geom_vline(data=df.sub.contr, aes(xintercept= matches.mean),
             linetype="dashed")+
  scale_x_continuous(breaks = seq(0, 110, by=20))+
  labs(title="Control groups by number of matches")+
  facet_grid(num.matches ~.)

ggplot(df.sub.case, aes(x=age)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.5,bins=30)+
  geom_density(alpha=0.5)+
  geom_vline(data=df.sub.case, aes(xintercept= matches.mean),
             linetype="dashed")+
  scale_x_continuous(breaks = seq(0, 110, by=20))+
  labs(title="Case group")

```

##### **Figure 3: distribution of mean age in matched pairs**
control: group mean by set_id
case: mean
```{r  echo=FALSE }

df.sub.set=df.sub%>%group_by(case,set_id)%>% summarise(m.age.setid= mean(age)) # matches only count once
df.sub.set=df.sub.set%>%group_by(case)%>%mutate(grp.mean.setid= mean(m.age.setid))

ggplot(df.sub.set, aes(x=m.age.setid, fill=case, color=case)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.1,bins=30)+
  geom_density(alpha=0.5)+
  geom_vline(data=df.sub.set, aes(xintercept=grp.mean.setid, color=case),
             linetype="dashed")+
  scale_x_continuous(breaks = seq(0, 110, by=10))

```



