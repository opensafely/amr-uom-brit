---
title: "conditional logistic regression"
---

```{r setup, include=FALSE}
#library(knitr)
library(dplyr)
#library(skimr)
library('tidyverse')
library("survival")
library(car)
library(pROC)
```

# import dataset
# import dataset
```{r }
#df<- read_rds("/Users/yayang/Documents/GitHub/amr-uom-brit/output/train_X.rds")
df1 <- read_rds(here::here("output","development.rds"))

df2 <- read_rds(here::here("output","validation.rds"))


df=rbind(df1,df2)
rm(df1,df2)

#abtype=read_rds("/Users/yayang/Documents/GitHub/amr-uom-brit/output/abtype.rds")
abtype <- read_rds(here::here("output","abtype.rds"))

#pred_col=c("patient_id","patient_index_date", "case","total_ab", "ab_prescriptions","ab_types","prescribe_times","exposure_period","recent_ab_days", "broad_prop" ,"broad_ab_prescriptions","interval_mean","interval_sd","interval_CV","length_mean", "length_sd", "length_CV","prescribe_time_0","prescribe_time_1","prescribe_time_2","prescribe_time_3",col,"AB_1_type","AB_6wk_type" ,"interval_med" ,"length_med" ,"ab_6w_binary" , "AB_6wk")
table(df$case)
str(df)

#df$case=as.factor(df$case)

names(df)
```


# overall
```{r }
df$case=as.numeric(df$case) #1/0
df$subclass=as.factor(df$subclass)#pair id
df$CCI= relevel(as.factor(df$CCI), ref="Zero")
df$covrx_ever= relevel(as.factor(df$covrx_ever), ref="0")
df$bmi_cat=relevel(as.factor(df$bmi_cat),ref="Healthy weight")
df$care_home=relevel(as.factor(df$care_home),ref = "0")
df$flu_vaccine=relevel(as.factor(df$flu_vaccine),ref= "0")
df$smoking_cat_3=relevel(as.factor(df$smoking_cat_3),ref="Never")
df$imd=relevel(as.factor(df$imd),ref="1")
df$ethnicity_6=relevel(as.factor(df$ethnicity_6),ref = "White")

```

# set group
```{r }

col=c("total_ab","ab_types","prescribe_times","exposure_period","recent_ab_days", "broad_prop","interval_med" ,"interval_mean","interval_sd","interval_CV",
           "length_mean","length_med", "length_sd", "length_CV" , "AB_6wk",abtype)

for (i in 1:length(col)) {
 df[,col[i]]=ifelse(df[,col[i]]>0,df[,col[i]],NA)
}

for (i in 1:length(col)) {
 df[,paste0(col[i],"_group")]=ntile(df[,col[i]],3)
}

for (i in 1:length(col)) {
 df[,col[i]]=ifelse(is.na(df[,col[i]]),0,df[,col[i]])
}

data=df
rm(df)
```

# correlation
```{r }

dat=data%>% select("total_ab","ab_types","exposure_period" ,"recent_ab_days", "broad_prop","interval_mean","interval_CV")
round(cor(dat),
  digits = 2 # rounded to 2 decimals
)
```

```{r}
df$total_ab_group=relevel(as.factor(df$total_ab_group),ref= "0")
df$ab_types_group=relevel(as.factor(df$ab_types_group),ref= "0")
df$exposure_period_group=relevel(as.factor(df$exposure_period_group),ref= "0")
df$recent_ab_days_group=relevel(as.factor(df$recent_ab_days_group),ref= "0")
df$broad_prop_group=relevel(as.factor(df$broad_prop_group),ref= "0")
df$interval_mean_group=relevel(as.factor(df$interval_mean_group),ref= "0")
df$interval_med_group=relevel(as.factor(df$interval_med_group),ref= "0")
df$interval_CV_group=relevel(as.factor(df$interval_CV_group),ref= "0")
df$interval_sd_group=relevel(as.factor(df$interval_sd_group),ref= "0")
df$length_med_group=relevel(as.factor(df$length_med_group),ref= "0")
df$length_mean_group=relevel(as.factor(df$length_mean_group),ref= "0")
df$length_CV_group=relevel(as.factor(df$length_CV_group),ref= "0")
df$length_sd_group=relevel(as.factor(df$length_sd_group),ref= "0")
df$ab_6wk_group=relevel(as.factor(df$ab_6wk_group),ref= "0")


names(df)
table(df$total_ab_group)
```

all
```{r eval=FALSE, include=FALSE}
model=clogit(case ~total_ab_group+ab_types_group+exposure_period_group+recent_ab_days_group+broad_prop_group+interval_mean_group +interval_CV_group+ CCI + covrx_ever + bmi_cat + care_home + flu_vaccine + smoking_cat_3 + imd+ ethnicity_6 + strata(subclass),data) 

summary(model)
```

```{r eval=FALSE, include=FALSE}
model=clogit(case ~total_ab_group+CCI + covrx_ever + bmi_cat + care_home + flu_vaccine + smoking_cat_3 + imd+ ethnicity_6 + strata(subclass),data) 

summary(model)
```

```{r eval=FALSE, include=FALSE}
model=clogit(case ~ab_types_group+ CCI + covrx_ever + bmi_cat + care_home + flu_vaccine + smoking_cat_3 + imd+ ethnicity_6 + strata(subclass),data) 

summary(model)
```

```{r eval=FALSE, include=FALSE}
model=clogit(case ~exposure_period_group+CCI + covrx_ever + bmi_cat + care_home + flu_vaccine + smoking_cat_3 + imd+ ethnicity_6 + strata(subclass),data) 

summary(model)
```

```{r eval=FALSE, include=FALSE}
model=clogit(case ~recent_ab_days_group + CCI +covrx_ever + bmi_cat + care_home + flu_vaccine + smoking_cat_3 + imd+ ethnicity_6 + strata(subclass),data) 

summary(model)
```

```{r eval=FALSE, include=FALSE}
model=clogit(case ~broad_prop_group + CCI + covrx_ever + bmi_cat + care_home + flu_vaccine + smoking_cat_3 + imd+ ethnicity_6 + strata(subclass),data) 

summary(model)
```

```{r eval=FALSE, include=FALSE}
model=clogit(case ~interval_mean_group + CCI + covrx_ever + bmi_cat + care_home + flu_vaccine + smoking_cat_3 + imd+ ethnicity_6 + strata(subclass),data) 

summary(model)
```

```{r eval=FALSE, include=FALSE}
model=clogit(case ~interval_med_group + CCI + covrx_ever + bmi_cat + care_home + flu_vaccine + smoking_cat_3 + imd+ ethnicity_6 + strata(subclass),data) 

summary(model)
```

```{r eval=FALSE, include=FALSE}
model=clogit(case ~ interval_CV_group+ CCI + covrx_ever + bmi_cat + care_home + flu_vaccine + smoking_cat_3 + imd+ ethnicity_6 + strata(subclass),data) 

summary(model)
```

```{r eval=FALSE, include=FALSE}
model=clogit(case ~ interval_sd_group+ CCI + covrx_ever + bmi_cat + care_home + flu_vaccine + smoking_cat_3 + imd+ ethnicity_6 + strata(subclass),data) 

summary(model)
```



```{r eval=FALSE, include=FALSE}
model=clogit(case ~length_mean_group + CCI + covrx_ever + bmi_cat + care_home + flu_vaccine + smoking_cat_3 + imd+ ethnicity_6 + strata(subclass),data) 

summary(model)
```

```{r eval=FALSE, include=FALSE}
model=clogit(case ~length_med_group + CCI + covrx_ever + bmi_cat + care_home + flu_vaccine + smoking_cat_3 + imd+ ethnicity_6 + strata(subclass),data) 

summary(model)
```

```{r eval=FALSE, include=FALSE}
model=clogit(case ~ length_CV_group+ CCI + covrx_ever + bmi_cat + care_home + flu_vaccine + smoking_cat_3 + imd+ ethnicity_6 + strata(subclass),data) 

summary(model)
```

```{r eval=FALSE, include=FALSE}
model=clogit(case ~ length_sd_group+ CCI + covrx_ever + bmi_cat + care_home + flu_vaccine + smoking_cat_3 + imd+ ethnicity_6 + strata(subclass),data) 

summary(model)
```
