---
title: "broad_spectrum_ab_freq"
author: "Billy Z"
date: "25/03/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
knitr::opts_knit$set(root.dir = '/workspace')
```


```{r echo=TRUE}
library("ggplot2")
library("dplyr")
library("tidyverse")
library('lubridate')
```



```{r echo=TRUE}
df <- read_csv(
  here::here("output", "measures", "measure_antibiotics_overall_brit_abtype.csv"),  
  col_types = cols_only(
    antibacterial_brit_abtype = col_character(),
    # Outcomes
    antibacterial_brit = col_double(),
    population = col_double(),
    value = col_double(),
    
    # Date
    date = col_date(format="%Y-%m-%d")
    
  ),
  na = character()
  )


df$date <- as.Date(df$date,format="%Y-%m-%d")
df[is.na(df)] <- 0 


# remove last month data
last.date=max(df$date)
df=df%>% filter(date!=last.date)
df$cal_mon <- month(df$date)

df$cal_year <- year(df$date)

first_mon=format(min(df$date),"%m-%Y")
last_mon= format(max(df$date),"%m-%Y")
df$year <- as.factor(df$cal_year)
df$mon <- as.factor(df$cal_mon)

```

## Broad_spectrum antibiotics frequency table

```{r echo=TRUE}

broadtype <- c("Amoxicillin","Ampicillin","Co-amoxiclav","Moxifloxacin","Cefaclor","Cefadroxil","Cefuroxime",     "Cefalexin","Cefazolin","Cefixime","Cefotaxime","Cefoxitin","Cefradine","Cefpirome","Ceftazidime","Ceftriaxone",    "Cefprozil","Ciprofloxacin","Co-fluampicil","Doripenem","Ertapenem", "Cilastatin","Cefamandole","Levofloxacin" , 
"Meropenem" ,"Nalidixic acid","Norfloxacin", "Ofloxacin","Cefpodoxime","Cefepime")


dfb <- df %>% filter(antibacterial_brit_abtype %in% broadtype )
dfb_total <- dfb %>% group_by(antibacterial_brit_abtype) %>% summarise(
  total_count = sum(antibacterial_brit, na.rm = TRUE)
)

dfb_total %>% arrange(desc(total_count))

```

## broad_type

```{r}

plot2<- ggplot(dfb, aes(x=date, y=antibacterial_brit ,group=antibacterial_brit_abtype,color=antibacterial_brit_abtype))+
  annotate(geom = "rect", xmin = as.Date("2021-01-01"),xmax = as.Date("2021-04-01"),ymin = -Inf, ymax = Inf,fill="grey80", alpha=0.5)+
  annotate(geom = "rect", xmin = as.Date("2020-11-01"),xmax = as.Date("2020-12-01"),ymin = -Inf, ymax = Inf,fill="grey80", alpha=0.5)+
  annotate(geom = "rect", xmin = as.Date("2020-03-01"),xmax = as.Date("2020-06-01"),ymin = -Inf, ymax = Inf,fill="grey80", alpha=0.5)+
  geom_line()+
  theme(legend.position = "bottom",legend.title =element_blank())+
  labs(
    fill = "Antibiotic type",
    title = "Broad- Spectrum Ab Types Prescribed",
    subtitle = paste(first_mon,"-",last_mon),
    y = "percent",
    x=""
  )+
  theme(axis.text.x=element_text(angle=60,hjust=1))+
  scale_x_date(date_labels = "%m-%Y", date_breaks = "1 month")
plot2


```








## Percentage diagram



```{r echo=TRUE}

df_total <-  df %>% group_by(date) %>% summarise(
  ab_total = sum(antibacterial_brit, na.rm = TRUE)
)
df_b <- dfb %>% group_by(date) %>% summarise(
  b_total = sum(antibacterial_brit, na.rm = TRUE)
)

plot1 <- merge(df_b,df_total, by = 'date')
plot1$cal_mon <- month(plot1$date)
plot1$cal_year <- year(plot1$date)
plot1$year <- as.factor(plot1$cal_year)
plot1$mon <- as.factor(plot1$cal_mon)
plot1 <- plot1 %>% mutate(prop = b_total/ab_total)


p1 <- ggplot(plot1, aes(x=mon, y=prop, group=year)) +
  geom_line(aes(color=year))+
  geom_point(aes(color=year))+
  scale_color_brewer(palette="Paired")+
  theme_minimal()+
  scale_y_continuous(labels = scales::percent,breaks=seq(0, 1, by = 0.005))+
  labs(
    title = "Proportion of broad-spectrum antibiotics prescribed",
    subtitle = paste(first_mon,"-",last_mon),
    x = "Month",
    y = "broad-spectrum antibiotics prescribing %")

p1


```


## excluded Amoxicillin

```{r}

broadtype2 <- c("Ampicillin","Co-amoxiclav","Moxifloxacin","Cefaclor","Cefadroxil","Cefuroxime",     "Cefalexin","Cefazolin","Cefixime","Cefotaxime","Cefoxitin","Cefradine","Cefpirome","Ceftazidime","Ceftriaxone",    "Cefprozil","Ciprofloxacin","Co-fluampicil","Doripenem","Ertapenem", "Cilastatin","Cefamandole","Levofloxacin" , 
"Meropenem" ,"Nalidixic acid","Norfloxacin", "Ofloxacin","Cefpodoxime","Cefepime")


dfb2 <- df %>% filter(antibacterial_brit_abtype %in% broadtype2 )

df_b2 <- dfb2 %>% group_by(date) %>% summarise(
  b_total = sum(antibacterial_brit, na.rm = TRUE)
)

plot3 <- merge(df_b2,df_total, by = 'date')
plot3$cal_mon <- month(plot3$date)
plot3$cal_year <- year(plot3$date)
plot3$year <- as.factor(plot3$cal_year)
plot3$mon <- as.factor(plot3$cal_mon)
plot3 <- plot3 %>% mutate(prop = b_total/ab_total)


p3 <- ggplot(plot3, aes(x=mon, y=prop, group=year)) +
  geom_line(aes(color=year))+
  geom_point(aes(color=year))+
  scale_color_brewer(palette="Paired")+
  theme_minimal()+
  scale_y_continuous(labels = scales::percent,breaks=seq(0, 1, by = 0.005))+
  labs(
    title = "Proportion of broad-spectrum antibiotics prescribed",
    subtitle = paste(first_mon,"-",last_mon),
    x = "Month",
    y = "broad-spectrum antibiotics prescribing %")

p3


```


```{r}
ablist <- c("Benzylpenicillin","Phenoxymethylpenicillin","Flucloxacillin",
            "Temocillin","Amoxicillin","Ampicillin","Co-fluampicil","Co-amoxiclav","Flucloxacillin",
            "Piperacillin","Ticarcillin","Pivmecillinam","Cefamandole","Cefazolin","Cefepime","Cefpirome",
            "Cefprozil","Cefaclor","Cefadroxil","Cefalexin","Cefixime","Cefotaxime","Cefoxitin","Cefpodoxime",
            "Cefradine","Ceftazidime","Ceftriaxone","Cefuroxime","Cilastatin","Doripenem","Ertapenem","Meropenem",
            "Aztreonam","Ampicillin",
"Demeclocycline" ,"Doxycycline",
 "Lymecycline", "Minocycline",
"Oxytetracycline", "Tetracycline",
"Tigecycline", "Amikacin",
"Gentamicin", "Neomycin",
"Netilmicin", "Tobramycin",
"Azithromycin", "Clarithromycin",
"Erythromycin", "Telithromycin",
 "Clindamycin" ,"Chloramphenicol",
"Colistimethate", "Dalbavancin",
"Dalfopristin", "Daptomycin",
"Fidaxomicin", "Fosfomycin",
"Fusidate", "Linezolid",
"Nitazoxanid", "Pristinamycin",
"Rifaximin", "Taurolidin",
"Tedizolid", "Teicoplanin",
"Vancomycin", "Sulfadiazine",
"Sulfamethoxazole", "Sulfapyridine",
"Trimethoprim", "Metronidazole",
"Tinidazole", "Amoxicillin",
"Ciprofloxacin", "Levofloxacin",
"Moxifloxacin", "Nalidixic acid",
"Norfloxacin", "Ofloxacin",
"Fosfomycin", "Methenamine",
 "Nitrofurantoin")

df_total2 <- df %>% filter(antibacterial_brit_abtype %in% ablist )
df_total2 <-  df_total2 %>% group_by(date) %>% summarise(
  ab_total = sum(antibacterial_brit, na.rm = TRUE)
)

broadtype2 <- c("Ampicillin","Co-amoxiclav","Moxifloxacin","Cefaclor","Cefadroxil","Cefuroxime",     "Cefalexin","Cefazolin","Cefixime","Cefotaxime","Cefoxitin","Cefradine","Cefpirome","Ceftazidime","Ceftriaxone",    "Cefprozil","Ciprofloxacin","Co-fluampicil","Doripenem","Ertapenem", "Cilastatin","Cefamandole","Levofloxacin" , 
"Meropenem" ,"Nalidixic acid","Norfloxacin", "Ofloxacin","Cefpodoxime","Cefepime")


dfb2 <- df %>% filter(antibacterial_brit_abtype %in% broadtype2 )

df_b2 <- dfb2 %>% group_by(date) %>% summarise(
  b_total = sum(antibacterial_brit, na.rm = TRUE)
)

plot4 <- merge(df_b2,df_total2, by = 'date')
plot4$cal_mon <- month(plot4$date)
plot4$cal_year <- year(plot4$date)
plot4$year <- as.factor(plot4$cal_year)
plot4$mon <- as.factor(plot4$cal_mon)
plot4 <- plot4 %>% mutate(prop = b_total/ab_total)


p4 <- ggplot(plot4, aes(x=mon, y=prop, group=year)) +
  geom_line(aes(color=year))+
  geom_point(aes(color=year))+
  scale_color_brewer(palette="Paired")+
  theme_minimal()+
  scale_y_continuous(labels = scales::percent,breaks=seq(0, 1, by = 0.0001))+
  labs(
    title = "Proportion of broad-spectrum antibiotics prescribed",
    subtitle = paste(first_mon,"-",last_mon),
    x = "Month",
    y = "broad-spectrum antibiotics prescribing %")

p4

```



