---
title: "COVID impact on onsultation rate"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = '/workspace')
```

## Interrupted time-series analysis

```{r message=FALSE}
library("ggplot2")
library("data.table")
library("dplyr")
library("tidyverse")
library("MASS")
#library("gtsummary")
```


### Import data

```{r message=FALSE}

filelist=c("consult_UTI.rds","consult_URTI.rds","consult_LRTI.rds","consult_sinusitis.rds","consult_ot_externa.rds","consult_otmedia.rds")

temp <- vector("list", length(filelist))

for (i in seq_along(filelist)){

df = read_rds(here::here("output","measures",filelist[i]))
# infection counts, population size, covid period
df = df%>% group_by(date, covid)%>% 
  summarise(counts=sum(infection_counts), 
            population=sum(population))
# month for seasonality
df$month= format(df$date,"%m")
# time elapsed(measurement time point) for linear effect of time to capture long-term behaviour trends
df$times <- as.numeric(as.factor(df$date))

temp[[i]]=df

rm(df)
}

```

```{r message=FALSE}
df1=temp[[1]]#uti
df2=temp[[2]]#urti
df3=temp[[3]]#lrti
df4=temp[[4]]#sinusitis
df5=temp[[5]]#otitis externa
df6=temp[[6]]#otitis media
rm(temp)
```


# Negative binomial model (without interaction)_model1

```{r message=FALSE}
summary(m1 <- glm.nb(counts~ offset(log(population))+ covid + month +times , data = df1))
summary(m2 <- glm.nb(counts~ offset(log(population))+ covid + month +times , data = df2))
summary(m3 <- glm.nb(counts~ offset(log(population))+ covid + month +times , data = df3))
summary(m4 <- glm.nb(counts~ offset(log(population))+ covid + month +times , data = df4))
summary(m5 <- glm.nb(counts~ offset(log(population))+ covid + month +times , data = df5))
summary(m6 <- glm.nb(counts~ offset(log(population))+ covid + month +times , data = df6))
```

### confidence intervals for the coefficients
```{r include=FALSE}
(est1 <- cbind(Estimate = coef(m1), confint(m1)))
(est2 <- cbind(Estimate = coef(m2), confint(m2)))
(est3 <- cbind(Estimate = coef(m3), confint(m3)))
(est4 <- cbind(Estimate = coef(m4), confint(m4)))
(est5 <- cbind(Estimate = coef(m5), confint(m5)))
(est6 <- cbind(Estimate = coef(m6), confint(m6)))

```

### calculate IRR & 95%CI
```{r}
est1=exp(est1)
est1=exp(est2)
est1=exp(est3)
est1=exp(est4)
est1=exp(est5)
est1=exp(est6)
```

##### combine results
```{r}

DF=bind_rows(est1[2,],est2[2,],est3[2,],est4[2,],est5[2,],est6[2,])

DF$Infection=c("UTI","URTI","LRTI","Sinusitis","Otitis externa","Otitis media")
#reorder
DF=DF%>%arrange(Infection)

names(DF)[1]="IRR"
names(DF)[2]="ci_l"
names(DF)[3]="ci_u"
DF
```


### result_model1
```{r}

#setting up the basic plot
p1 <- ggplot(data=DF, aes(y=Infection, x=IRR, xmin=ci_l, xmax=ci_u))+ 

#this adds the effect sizes to the plot
geom_point()+ 

#adds the CIs
geom_errorbarh(height=.1)+

#adding a vertical line at the effect = 0 mark
geom_vline(xintercept=0, color="black", linetype="dashed", alpha=.5)+
  
#thematic stuff
theme_minimal()+
theme(text=element_text(family="Times",size=18, color="black"))+
theme(panel.spacing = unit(1, "lines"))+

labs(
    title = "Consultation Reduction",
    x="IRR (95%)"
  )

```



# Negative binomial model (adding interaction)_model2

```{r message=FALSE}

m1.1=update(m1, .~. +times*covid)
m2.1=update(m2, .~. +times*covid)
m3.1=update(m3, .~. +times*covid)
m4.1=update(m4, .~. +times*covid)
m5.1=update(m5, .~. +times*covid)
m6.1=update(m6, .~. +times*covid)
```

### confidence intervals for the coefficients
```{r message=FALSE}
(est1.1 <- cbind(Estimate = coef(m1.1), confint(m1.1)))
(est2.1 <- cbind(Estimate = coef(m2.1), confint(m2.1)))
(est3.1 <- cbind(Estimate = coef(m3.1), confint(m3.1)))
(est4.1 <- cbind(Estimate = coef(m4.1), confint(m4.1)))
(est5.1 <- cbind(Estimate = coef(m5.1), confint(m5.1)))
(est6.1 <- cbind(Estimate = coef(m6.1), confint(m6.1)))

```

### calculate IRR & 95%CI
```{r}
est1.1=exp(est1.1)
est1.1=exp(est2.1)
est1.1=exp(est3.1)
est1.1=exp(est4.1)
est1.1=exp(est5.1)
est1.1=exp(est6.1)
```

## combine results
```{r}

DF=bind_rows(est1.1[2,],est2.1[2,],est3.1[2,],est4.1[2,],est5.1[2,],est6.1[2,])
DF$Infection=c("UTI","URTI","LRTI","Sinusitis","Otitis externa","Otitis media")
#reorder
DF=DF%>%arrange(Infection)

names(DF)[1]="IRR"
names(DF)[2]="ci_l"
names(DF)[3]="ci_u"
DF
```


### Model2_result
```{r}

#setting up the basic plot
p2 <- ggplot(data=DF, aes(y=Infection, x=IRR, xmin=ci_l, xmax=ci_u))+ 

#this adds the effect sizes to the plot
geom_point()+ 

#adds the CIs
geom_errorbarh(height=.1)+

#adding a vertical line at the effect = 0 mark
geom_vline(xintercept=1, color="black", linetype="dashed", alpha=.5)+
  
#thematic stuff
theme_minimal()+
theme(text=element_text(family="Times",size=18, color="black"))+
theme(panel.spacing = unit(1, "lines"))+

labs(
    x="IRR (95%)"
  )
```



# Negative binomial model (adding interaction)_model3

```{r}
m1.2=update(m1, .~.  +times*covid +m1.1$residuals)
m2.2=update(m2, .~.  +times*covid +m2.1$residuals)
m3.2=update(m3, .~.  +times*covid +m3.1$residuals)
m4.2=update(m4, .~.  +times*covid +m4.1$residuals)
m5.2=update(m5, .~.  +times*covid +m5.1$residuals)
m6.2=update(m6, .~.  +times*covid +m6.1$residuals)
```

### confidence intervals for the coefficients
```{r message=FALSE}
(est1.2 <- cbind(Estimate = coef(m1.2), confint(m1.2)))
(est2.2 <- cbind(Estimate = coef(m2.2), confint(m2.2)))
(est3.2 <- cbind(Estimate = coef(m3.2), confint(m3.2)))
(est4.2 <- cbind(Estimate = coef(m4.2), confint(m4.2)))
(est5.2 <- cbind(Estimate = coef(m5.2), confint(m5.2)))
(est6.2 <- cbind(Estimate = coef(m6.2), confint(m6.2)))

```

### calculate IRR & 95%CI
```{r}
est1.2=exp(est1.2)
est1.2=exp(est2.2)
est1.2=exp(est3.2)
est1.2=exp(est4.2)
est1.2=exp(est5.2)
est1.2=exp(est6.2)
```

## combine results
```{r}

DF=bind_rows(est1.2[2,],est2.2[2,],est3.2[2,],est4.2[2,],est5.2[2,],est6.2[2,])

DF$Infection=c("UTI","URTI","LRTI","Sinusitis","Otitis externa","Otitis media")
#reorder
DF=DF%>%arrange(Infection)

names(DF)[1]="IRR"
names(DF)[2]="ci_l"
names(DF)[3]="ci_u"
DF
```


### result_model3
```{r}

#setting up the basic plot
p3 <- ggplot(data=DF, aes(y=Infection, x=IRR, xmin=ci_l, xmax=ci_u))+ 

#this adds the effect sizes to the plot
geom_point()+ 

#adds the CIs
geom_errorbarh(height=.1)+

#adding a vertical line at the effect = 0 mark
geom_vline(xintercept=1, color="black", linetype="dashed", alpha=.5)+
  
#thematic stuff
theme_minimal()+
theme(text=element_text(family="Times",size=18, color="black"))+
theme(panel.spacing = unit(1, "lines"))+

labs( title = "Consultation Reduction",
    x="IRR (95%)"
  )

```


# comparing results
## model_1 without interaction
```{r}
p1
```

## model_2 add interaction
```{r}
p2
```

## model_3
```{r}
p3
```

## comparing models
```{r}
anova(m1,m1.1)
anova(m1.1,m1.2)
```

