---
title: "Matching Report 3"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r packages, include=FALSE}
require('tidyverse')
require("gtsummary")
require("ggplot2")
```

# <font color=blue>**Outcome 3**</font>
```{r include=FALSE}
# import data
rm(list=ls())

df <- read_csv(here::here("output","matched_outcome3.csv"))
df$wave=as.factor(df$wave)
df$patient_id=as.factor(df$patient_id)
df$set_id=as.factor(df$set_id)
df$case=as.factor(df$case)
df$match_counts=as.integer(df$match_counts)
df$sex=as.character(df$sex)
df$age=as.numeric(df$age)
df$age_cat=as.character(df$age_cat)
df$stp=as.character(df$stp)
df$region=as.character(df$region)
df$ethnicity_6=as.character(df$ethnicity_6)
df$bmi=as.numeric(df$bmi)
df$bmi_cat=as.character(df$bmi_cat)
df$CCI=as.character(df$CCI)
df$Charlson=as.integer(df$Charlson)
df$smoking_cat_3=as.character(df$smoking_cat_3)
df$imd=as.integer(df$imd)
df$care_home=as.integer(df$care_home)
df$covrx_ever=as.integer(df$covrx_ever)
df$flu_vaccine=as.integer(df$flu_vaccine)
df$ab_types=as.integer(df$ab_types)
df$lastABtime=as.factor(df$lastABtime)
df$ab_qn=as.integer(df$ab_qn)
df$br_ab_qn=as.integer(df$ab_qn)
```


```{r include=FALSE}
# number of patients in case group
num.case=length(unique(df[df$case=="1",]$patient_id))
```

#### Cases: COVID ICU or Death / **count:`r num.case`**

```{r include=FALSE}
# number of patients in control group
num.contr=length(unique(df[df$case=="0",]$patient_id))
```

#### Controls: COVID hospital admission /  **count:`r num.contr`**

***

# Matched pairs 
#### *1:6 matching by age (within 5 years), sex, region (stp)*

**number of matched controls per case**
```{r}

control=subset(df,df$case=="0")
control=control%>%group_by(set_id)%>%summarise(num.matches=n())

# number of matched controls per case
table(control$num.matches)
# proportional of matched controls per case
round(prop.table(table(control$num.matches)),digits=2)

contr=subset(df,df$case=="0")
table(contr$match_count)
round(prop.table(table(contr$match_count)),digits=2)
```



### Distribution of Age

##### **Figure 1: age distribution **

This plot shows the age distribution of matched study population by outcome groups. Group averages are shown as dashed lines.
```{r  echo=FALSE }
df.sub <- df %>% select(patient_id, case, set_id, age,age_cat, sex, region)
df.sub$case=as.factor(df.sub$case)
# calculate mean of age in both case and control groups
df.sub=df.sub%>%group_by(case)%>%mutate(grp.mean= mean(age))

ggplot(df.sub, aes(x=age, fill=case, color=case)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.1,bins=30)+
  geom_density(alpha=0.5)+
  geom_vline(data=df.sub, aes(xintercept=grp.mean, color=case),
             linetype="dashed")+
  scale_x_continuous(breaks = seq(0, 110, by=10))

```

##### **Figure 2: age distribution by matching numbers**

These plots present age distribution divided by numbers of matches in controls.
```{r  echo=FALSE }
df.sub=df.sub%>%group_by(case,set_id)%>%mutate(num.matches=n())
df.sub=df.sub%>%group_by(case,num.matches)%>%mutate( matches.mean=mean(age))
df.sub$num.matches=as.factor(df.sub$num.matches)

df.sub.contr=subset(df.sub, case=="0")
df.sub.case=subset(df.sub, case=="1")

ggplot(df.sub.contr, aes(x=age)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.5,bins=30)+
  geom_density(alpha=0.5)+
  geom_vline(data=df.sub.contr, aes(xintercept= matches.mean),
             linetype="dashed")+
  scale_x_continuous(breaks = seq(0, 110, by=20))+
  labs(title="Control groups by number of matches")+
  facet_grid(num.matches ~.)

ggplot(df.sub.case, aes(x=age)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.5,bins=30)+
  geom_density(alpha=0.5)+
  geom_vline(data=df.sub.case, aes(xintercept= matches.mean),
             linetype="dashed")+
  scale_x_continuous(breaks = seq(0, 110, by=20))+
  labs(title="Case group")

```

##### **Figure 3: distribution of mean age in matched  pairs**
The plots below show the distribution about means of age within each "set_id", which indicated the paris of case and control pairs.
```{r  echo=FALSE }

df.sub.set=df.sub%>%group_by(case,set_id)%>% summarise(m.age.setid= mean(age)) # matches only count once
df.sub.set=df.sub.set%>%group_by(case)%>%mutate(grp.mean.setid= mean(m.age.setid))

ggplot(df.sub.set, aes(x=m.age.setid, fill=case, color=case)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.1,bins=30)+
  geom_density(alpha=0.5)+
  geom_vline(data=df.sub.set, aes(xintercept=grp.mean.setid, color=case),
             linetype="dashed")+
  scale_x_continuous(breaks = seq(0, 110, by=10))

```

### Comparison table of case & control groups

##### **1. Matching Variables **

```{r  echo=FALSE }

df.m=df%>% select(case, age,age_cat, sex, stp,region)
df$age=as.numeric(df$age)

df.m %>%
  tbl_summary(
    by = case,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)")) %>%
  bold_labels()

```


##### **2. Confounding variables **
```{r  echo=FALSE }
df.con <- df %>% select(case, wave, ethnicity_6, bmi, bmi_cat,care_home,imd, smoking_cat_3,covrx_ever,flu_vaccine,Charlson,CCI)
```

```{r  echo=FALSE }
df.con %>%
  tbl_summary(
    by = case,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)")) %>%
  bold_labels()

```


##### **3. Antibiotics exposure variables**
```{r  echo=FALSE }
df.ab <- df %>% select(case,ab_types,ab_prescriptions,ab_qn,broad_ab_prescriptions,br_ab_qn,lastABtime,interval)

df$broad_ab_prescriptions=as.numeric(df$broad_ab_prescriptions)
df$lastABtime=as.integer(df$lastABtime)
#df.ab$ab_prescriptions=as.numeric(as.character( df.ab$ab_prescriptions))

df.ab %>%
  tbl_summary(
    by = case,
    type = list(c("ab_prescriptions","broad_ab_prescriptions") ~ 'continuous'),
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)")) %>%
  bold_labels()

```


```{r echo=FALSE }

# select unmatched cases
# matches not found
#unmatched=sum(table(df$set_id)=="1")
df.sub.unmatch=df %>% group_by(set_id) %>% filter(n() == 1) # if matched pair: n>=2
unmatched=length(as.factor(df.sub.unmatch$patient_id))
# select matched cases
df.sub.match=subset(df.sub.case,  !df.sub.case$patient_id %in% df.sub.unmatch$patient_id)
matched=length(as.factor(df.sub.match$patient_id))

```

***

# Cases: control not found
##### **Unmatched cases count:`r unmatched`**
##### **Matched cases count:`r matched`**
```{r echo=FALSE }

# unmatched cases

df.sub.unmatch=subset(df.sub.unmatch, select = c("patient_id","sex","age"))
df.sub.unmatch= df.sub.unmatch%>%mutate(mean.age=mean(age), matched="0")

df.sub.match=subset(df.sub.match, select = c("patient_id","sex","age"))
df.sub.match= df.sub.match%>%mutate(mean.age=mean(age), matched="1")

DF=rbind(df.sub.match, df.sub.unmatch)


ggplot(DF, aes(x=age)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.5,bins=30)+
  geom_density(alpha=0.5)+
  geom_vline(data=DF, aes(xintercept=mean.age),
             linetype="dashed")+
  scale_x_continuous(breaks = seq(0, 110, by=20))+
  facet_grid(matched ~.)+
  labs(caption="0=unmatched cases, 1=matched cases")
```
```{r echo=FALSE}
df.case=subset(df, df$case==1)
DF=subset(DF,select=c("patient_id","matched"))
df.case=merge(df.case,DF,by="patient_id")
```

### Comparison table of matched & unmatched cases

```{r echo=FALSE}
df.case$matched=as.factor(df.case$matched)

df.case %>%
  select(matched,age,bmi,Charlson,ab_types,ab_prescriptions,broad_ab_prescriptions) %>%
  tbl_uvregression(
    method = glm,
    y = matched,
    method.args = list(family = binomial),
    exponentiate = TRUE,
    pvalue_fun = ~style_pvalue(.x, digits = 2)
  ) %>%
  add_global_p() %>%  # add global p-value 
  add_nevent() %>%    # add number of events of the outcome
  bold_p() %>%        # bold p-values under a given threshold (default 0.05)
   bold_labels()

```
