---
title: "Random Forest model_ decile groups of probabilities"
---

```{r setup, include=FALSE}
library(dplyr)
library('tidyverse')
library(pROC)
library(randomForest)

```

# import dataset
```{r }
# original dataset
#DF <- read_rds("/Users/yayang/Documents/GitHub/amr-uom-brit/output/matched_outcome.rds")
DF<- read_rds(here::here("output","matched_outcome.rds"))
col1=c("wave","patient_index_date","patient_id","subclass","case","sex","age","age_cat","stp","region","ethnicity_6","bmi","bmi_cat","CCI","Charlson","smoking_cat_3","imd","care_home","covrx_ever","flu_vaccine","care_home_type","hospital_counts")
DF=subset(DF,select=col1)

DF$patient_id=as.factor(DF$patient_id)
nrow(DF)
table(DF$case)

DF=DF%>%distinct(patient_index_date,patient_id, .keep_all = TRUE)

#df <- read_rds("/Users/yayang/Documents/GitHub/amr-uom-brit/output/matched_ab.rds")
#df <- read_rds(here::here("output","matched_ab.rds"))
#table(df$case)
#col2=c("patient_index_date","patient_id","AB_6wk_type","ab_6w_binary" , "AB_6wk")
#df=subset(df,select=col2)
#df=df%>% distinct(patient_id,patient_index_date, .keep_all=T)
#nrow(df)

#DF=merge(DF,df,by=c("patient_id","patient_index_date"), all.x = T)
#table(DF$case)
#nrow(DF)
```


```{r }
#train_X <- read_rds("/Users/yayang/Documents/GitHub/amr-uom-brit/output/train_X.rds")
train <- read_rds(here::here("output","train_X.rds"))
train$case=as.factor(train$case)
train$patient_id=as.factor(train$patient_id)

#valid_X <- read_rds("/Users/yayang/Documents/GitHub/amr-uom-brit/output/valid_X.rds")
valid <- read_rds(here::here("output","valid_X.rds"))
valid$case=as.factor(valid$case)
valid$patient_id=as.factor(valid$patient_id)

table(train$case)
table(valid$case)


abtype <- read_rds(here::here("output","abtype.rds"))
col=c("patient_id","patient_index_date","total_ab","ab_types","prescribe_times","exposure_period","recent_ab_days", "broad_prop","interval_med" ,"interval_mean","interval_sd","interval_CV",
           "length_mean","length_med", "length_sd", "length_CV" , "AB_6wk",abtype)

train=train%>% select(col)
valid=valid%>% select(col)

#table(train$case)
#table(valid$case)

rf.model=readRDS(here::here("output","model_RandomForest.rds"))
print(rf.model)
```

filter ab>0
```{r}

train_X=train%>% filter(total_ab>0)
nrow(train_X)

valid_X=valid%>% filter(total_ab>0)
nrow(valid_X)

```


development set
```{r}
# probabilities of being case
prob <- predict(rf.model, train_X, type = 'prob')[,2]
summary(prob)
hist(prob)

sum(prob==0)
length(prob)

#exp.class <- predict(rf.model, train_X, type = 'response')
#summary(exp.class)

# create 10 risk groups
#prob=ifelse(prob==0,NA,prob)
decile <- ntile(prob,10)

#prob=ifelse(is.na(prob),0,prob)
#decile=ifelse(is.na(decile),0,decile)
train_X=train_X%>%select(patient_id,patient_index_date)

# combined
#train_X=train_X[,c("patient_id","patient_index_date")]
development <- cbind(train_X,decile,prob)


for (i in 1:10) {
  
  print(paste0("decile=",i))
  print(summary(development[decile==i,]$prob))

}
development$set=0

nrow(development)
```

validation set
```{r}
rm(prob)
# probabilities of being case
prob <- predict(rf.model, valid_X, type = 'prob')[,2]
summary(prob)
hist(prob)

sum(prob==0)
length(prob)

#exp.class <- predict(rf.model, valid_X, type = 'response')
#summary(exp.class)

#prob=ifelse(prob==0,NA,prob)

decile <- ntile(prob,10)
summary(decile)
#prob=ifelse(is.na(prob),0,prob)
#decile=ifelse(is.na(decile),0,decile)
#valid_X=valid_X[,c("patient_id","patient_index_date")]
valid_X=valid_X%>%select(patient_id,patient_index_date)

# combined
validation<- cbind(valid_X,decile,prob)

for (i in 1:10) {
  
  print(paste0("decile=",i))
  print(summary(validation[decile==i,]$prob))

}

nrow(validation)

validation$set=1
```


merge train&valid(1:6)
```{r}
nrow(train)
nrow(development)
nrow(valid)
nrow(validation)

df0=merge(train,development, by="patient_id", all.x=TRUE)
df1=merge(valid,validation, by="patient_id", all.x=TRUE)
nrow(df0)
nrow(df1)
```



```{r}

train_idx=train$patient_id
valid_idx=valid$patient_id

DF0=DF%>%filter(patient_id %in% train_idx)
DF1=DF%>%filter(patient_id %in% valid_idx)
nrow(DF0)
nrow(DF1)


```







```{r}

df0$decile=ifelse(is.na(df0$decile),0,df0$decile)
df0$prob=ifelse(is.na(df0$prob),0,df0$prob)

df1$decile=ifelse(is.na(df1$decile),0,df1$decile)
df1$prob=ifelse(is.na(df1$prob),0,df1$prob)

nrow(df0)
nrow(df1)
```



add confounder
```{r}
df0=merge(df0,DF0, by="patient_id", all.x=TRUE)
df1=merge(df1,DF1, by="patient_id", all.x=TRUE)

nrow(df0)
nrow(df1)
```


```{r}

saveRDS(df0,here::here("output","development.rds"))
saveRDS(df1,here::here("output","validation.rds"))

```
