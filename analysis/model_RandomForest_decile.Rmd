---
title: "Random Forest model_ decile groups of probabilities"
---

```{r setup, include=FALSE}
library(dplyr)
library('tidyverse')
library(pROC)
library(randomForest)

```

# 1:6 matched patients
```{r }
# original dataset
setwd("/Users/yayang/Documents/GitHub/amr-uom-brit/output/")
DF<- read_rds(here::here("output","matched_outcome.rds"))
col=c("wave","patient_index_date","patient_id","subclass","case",
       "sex","age","age_cat","stp","region",
       "ethnicity_6","bmi","bmi_cat","CCI","Charlson","smoking_cat_3","imd","care_home","covrx_ever","flu_vaccine","care_home_type","hospital_counts")
#"cancer_comor","cerebrovascular_disease_comor", "chronic_obstructive_pulmonary_comor", "heart_failure_comor", "connective_tissue_comor", "dementia_comor", "diabetes_comor", "diabetes_complications_comor", "hemiplegia_comor", "hiv_comor", "metastatic_cancer_comor", "mild_liver_comor", "mod_severe_liver_comor", "mod_severe_renal_comor", "mi_comor", "peptic_ulcer_comor", "peripheral_vascular_comor",
DF=DF[col]

str(DF)
#sum(is.na(DF$case))# 0
#sum(is.na(DF$patient_id))# 0
#sum(is.na(DF$patient_index_date))# 0

```

# train and valid dataset (matched)
```{r }
train_X <- read_rds(here::here("output","train_X.rds"))
train_X$case=as.factor(train_X$case)
valid_X <- read_rds(here::here("output","valid_X.rds"))
valid_X$case=as.factor(valid_X$case)

names(train_X)
```

## compare patient number (matched)
```{r}

nrow(DF)# total matched patients
table(DF$case)# total case/control
prop.table(table(DF$case))# % total patients

nrow(train_X)# train patients (matched)
table(train_X$case)# total train patients
prop.table(table(train_X$case))# % train patients

nrow(valid_X)# valid patients(matched)
table(valid_X$case)# total valid patients
prop.table(table(valid_X$case))# % valid patients
```

# distint patients to merge
```{r}
train_X=train_X%>% distinct(as.factor(patient_id), .keep_all = TRUE)
valid_X=valid_X%>% distinct(as.factor(patient_id), .keep_all = TRUE)

```

## compare patient number (distinct)
```{r}
nrow(train_X)# train patients (matched)
table(train_X$case)# total train patients
prop.table(table(train_X$case))# % train patients

nrow(valid_X)# valid patients(matched)
table(valid_X$case)# total valid patients
prop.table(table(valid_X$case))# % valid patients
```

# import RF model
```{r }
rf.model=readRDS(here::here("output","model_RandomForest.rds"))
print(rf.model)
input=rownames(data.frame(rf.model$importance))
input
```

# select columns
```{r }
abtype <- read_rds(here::here("output","abtype.rds"))
col=c("patient_id","patient_index_date",input)

train_X=train_X[col]
valid_X=valid_X[col]

str(train_X)
```

# development set
## predict probabilities 
```{r}
prob <- predict(rf.model, train_X, type = 'prob')[,2]# votes of being case

summary(prob)
hist(prob)
sum(prob==0)/length(prob)# % zero

exp.class <- predict(rf.model, train_X, type = 'response')# predicted case/control
prop.table(summary(exp.class))

# create 10 risk groups
prob=ifelse(prob==0,NA,prob) # 
decile <- ntile(prob,10)
summary(decile)

prob=ifelse(is.na(prob),0,prob)
decile=ifelse(is.na(decile),0,decile)


# combined
#train_X=train_X[,c("patient_id","patient_index_date")]
devel <- cbind(train_X,decile,prob,exp.class)


for (i in 1:10) {
  
  print(paste0("decile=",i))
  print(summary(devel[decile==i,]$prob))

}
nrow(devel)

devel$set=0


```




validation set
```{r}
rm(prob)
# probabilities of being case
prob <- predict(rf.model, valid_X, type = 'prob')[,2]
summary(prob)
hist(prob)

sum(prob==0)
length(prob)

exp.class <- predict(rf.model, valid_X, type = 'response')
summary(exp.class)

prob=ifelse(prob==0,NA,prob)


decile <- ntile(prob,10)
summary(decile)

prob=ifelse(is.na(prob),0,prob)
decile=ifelse(is.na(decile),0,decile)


#valid_X=valid_X[,c("patient_id","patient_index_date")]

# combined
valid<- cbind(valid_X,decile,prob,exp.class)

for (i in 1:10) {
  
  print(paste0("decile=",i))
  print(summary(valid[decile==i,]$prob))

}

nrow(valid)


valid$set=1
```


```{r}
nrow(DF)

data=rbind(devel,valid)
nrow(data)
df=merge(DF,data, by=c("patient_id","patient_index_date"), all.x=T)

nrow(df)

df0=df%>%filter(set==0)
df1=df%>%filter(set==1)
nrow(df0)
nrow(df1)

saveRDS(df0,here::here("output","development.rds"))
saveRDS(df1,here::here("output","validation.rds"))

```

