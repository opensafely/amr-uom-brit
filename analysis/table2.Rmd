---
title: "table 2"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r packages, include=FALSE}
require('tidyverse')
require("gtsummary")
```


# all data

```{r}
#df1=read_rds("/Users/yayang/Documents/GitHub/amr-uom-brit/output/matched_outcome.rds")

df1 <- read_rds(here::here("output","matched_outcome.rds"))
df1=df1%>% select("case","subclass","ethnicity_6",  "bmi_cat",  "CCI",  "smoking_cat_3","imd","care_home_type","care_home","covrx_ever","flu_vaccine",
"cancer_comor","cerebrovascular_disease_comor", "chronic_obstructive_pulmonary_comor", "heart_failure_comor", "connective_tissue_comor", "dementia_comor", "diabetes_comor", "diabetes_complications_comor", "hemiplegia_comor", "hiv_comor", "metastatic_cancer_comor", "mild_liver_comor", "mod_severe_liver_comor", "mod_severe_renal_comor", "mi_comor", "peptic_ulcer_comor", "peripheral_vascular_comor","total_ab")



```

```{r}

#df0=df0%>%select("stp")

table1 <- 
  tbl_summary(
    df1,
    by = case, 
    statistic = list(all_continuous() ~ "{mean} ({sd})",
                     all_categorical() ~ "{n}  ({p}%)"),
    digits = all_continuous() ~ 2,
  ) %>%
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels() 

table1
```


# remove outlier

```{r}
df=df1

count(df)
# 99%percentile
outlier=quantile(df$total_ab,0.99,na.rm=T)
outlier

df$outlier=ifelse(df$total_ab>outlier,1,0)

# remove control outlier
df$exclude.controls=ifelse(df$case==0 & df$outlier==1,1,0)

df=df%>%filter(exclude.controls != 1)
count(df)

# remove whole subclass (case outlier)
df$exclude.case=ifelse(df$case==1 & df$outlier==1,1,0)
df=df%>%group_by(subclass)%>%mutate(exclude.subclass= max(exclude.case))
df=df%>%filter(exclude.subclass !=1)
count(df)


```

```{r}

#df0=df0%>%select("stp")

table1 <- 
  tbl_summary(
    df,
    by = case, 
    statistic = list(all_continuous() ~ "{mean} ({sd})",
                     all_categorical() ~ "{n}  ({p}%)"),
    digits = all_continuous() ~ 2,
  ) %>%
  modify_header(label = "**Variable**") %>% # update the column header
  bold_labels() 

table1
```
