---
title: "classification comparison: RF "
---

```{r setup, include=FALSE}
library("survival")
library('tidyverse')
library(pROC) #plyr
library(caret) #dplyr
library(randomForest)
```

# import dataset
```{r }
train <- read_rds(here::here("output","train_X.rds"))
train$case=as.factor(train$case)
train=train%>%filter(total_ab>0)
train= train%>% group_by(subclass, case)%>%sample_n(1)
train=train%>% ungroup(subclass,case)

valid <- read_rds(here::here("output","valid_X.rds"))
valid$case=as.factor(valid$case)

table(train$case)
table(valid$case)
```

# separate dataset: random one control
```{r eval=FALSE, include=FALSE}

set.seed(123)
train=train%>%group_by(case, subclass)%>%sample_n(1)
valid=valid%>%group_by(case, subclass)%>%sample_n(1)

table(train$case)
table(valid$case)

train=train%>%ungroup(case,subclass)
valid=valid%>%ungroup(case,subclass)

saveRDS(train, here::here("output","train_1control.rds"))
saveRDS(valid, here::here("output","valid_1control.rds"))
```


# pick variable
```{r}
names(train)
col=c("case","total_ab","ab_types",
      "exposure_period","recent_ab_days",
      "broad_ab_prescriptions",
      "interval_med" ,"interval_sd")
#"broad_prop_total"

train=train[col]

str(train)
data=train
```


http://www.sthda.com/english/articles/35-statistical-machine-learning-essentials/141-cart-model-decision-tree-essentials/
```{r eval=FALSE, include=FALSE}
set.seed(1024)
#for (i in 1:nrow(result)) {

data$case=as.factor(data$case)  
  rf.model <-train(case ~ ., 
                  data=data, method="rpart",
                  trControl = trainControl("cv", number = 5),
                  maxdepth= 5)
  
  print(rf.model)
#  plot(rf.model)
  #  rf.model$bestTune
```


```{r eval=FALSE, include=FALSE}
summary(rf.model$finalModel)
```

# Plot the final tree model
```{r eval=FALSE, include=FALSE}
par(xpd = NA) # Avoid clipping the text in some device
plot(rf.model$finalModel)
text(rf.model$finalModel,  digits = 3)
```


```{r}
library(rpart)
rf.model<- rpart(
  case ~ ., 
  data = data, 
  method = "class", 
  minsplit = 2, 
  minbucket = 1)

print(rf.model)
par(xpd = NA)
plot(rf.model)
text(rf.model,  digits = 3)
```


```{r}
rf.model <- randomForest(formula = case ~ ., data = data, 
                           replace = TRUE,
                           ntree =  10,
                           sampsize = round(nrow(data)*0.6),
                           nodesize = 25 ,
                           mtry = sqrt(ncol(data)-1)
                          )
  print(rf.model)
```


```{r}
getTree(rf.model, k=1, labelVar=TRUE)
getTree(rf.model, k=3, labelVar=TRUE)
getTree(rf.model, k=5, labelVar=TRUE)
getTree(rf.model, k=7, labelVar=TRUE)
getTree(rf.model, k=9, labelVar=TRUE)

```

