---
title: "baseline table confounders"
output: 
  html_document:
   toc: true
   toc_depth: 2
   toc_float:
     collapsed: false
     smooth_scorll: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r packages, include=FALSE}
library('tidyverse')
library("ggplot2")
#library("plyr")
library('dplyr')
library('lubridate')
library('stringr')
library("data.table")
library("ggpubr")
library("finalfit")
```

```{r include=FALSE}
data=readRDS(here::here("output","matched_ab.rds"))
```

# categorised ab exposure variables
```{r }
col=c(
  "total_ab","ab_types","prescribe_times",
         "exposure_period","recent_ab_days", 
         "broad_prop","broad_ab_prescriptions",
         "interval_mean","interval_med" ,"interval_sd","interval_CV",
         "length_mean","length_med", "length_sd","length_CV")
data$case=as.factor(data$case)
data=data %>% mutate_at(col,as.numeric)
names(data)

for (k in 3:17) {

cut_value=quantile(data[,col[k]],c(0.25,0.5,0.75))
print(cut_value)
  
data[,paste0(col[k],"_group")]=ifelse(
  data[,col[k]] <= cut_value[1],1,NA)  

data[,paste0(col[k],"_group")]=ifelse(
  data[,col[k]] > cut_value[1] & data[,col[k]]<= cut_value[2],2, 
  data[,paste0(col[k],"_group")])  

data[,paste0(col[k],"_group")]=ifelse(
  data[,col[k]] > cut_value[2] & data[,col[k]]<= cut_value[3],3, 
  data[,paste0(col[k],"_group")])  

data[,paste0(col[k],"_group")]=ifelse(
  data[,col[k]] > cut_value[3],4,data[,paste0(col[k],"_group")])  

data[,paste0(col[k],"_group")]=ifelse(
 is.na( data[,col[k]]) ,0 ,data[,paste0(col[k],"_group")])  



}

data$total_ab_group=relevel(as.factor(data$total_ab_group),ref= "1")
data$ab_types_group=relevel(as.factor(data$ab_types_group),ref= "1")
data$exposure_period_group=relevel(as.factor(data$exposure_period_group),ref= "1")
data$recent_ab_days_group=relevel(as.factor(data$recent_ab_days_group),ref= "1")
data$broad_prop_group=relevel(as.factor(data$broad_prop_group),ref= "1")
data$broad_ab_prescriptions_group=relevel(as.factor(data$broad_ab_prescriptions_group),ref= "1")
data$interval_mean_group=relevel(as.factor(data$interval_mean_group),ref= "1")
data$interval_med_group=relevel(as.factor(data$interval_med_group),ref= "1")
data$interval_CV_group=relevel(as.factor(data$interval_CV_group),ref= "1")
data$interval_sd_group=relevel(as.factor(data$interval_sd_group),ref= "1")
data$length_med_group=relevel(as.factor(data$length_med_group),ref= "1")
data$length_mean_group=relevel(as.factor(data$length_mean_group),ref= "1")
data$length_CV_group=relevel(as.factor(data$length_CV_group),ref= "1")
data$length_sd_group=relevel(as.factor(data$length_sd_group),ref= "1")

prop.table(table(data$total_ab_group))
prop.table(table(data$ab_types_group))
prop.table(table(data$exposure_period_group))
prop.table(table(data$recent_ab_days_group))
prop.table(table(data$broad_ab_prescriptions_group))
prop.table(table(data$interval_med_group))
prop.table(table(data$interval_sd_group))

df=data
```

# original
```{r}
dependent <- "case"
explanatory<- c("total_ab_group","exposure_period_group","interval_mean_group","interval_sd_group","recent_ab_days_group","ab_types_group","broad_ab_prescriptions_group")
contd<- c("total_ab", "exposure_period","recent_ab_days","interval_mean","interval_sd","ab_types","broad_ab_prescriptions")
```

```{r}
range(data$total_ab)
range(data$ab_types)
range(data$exposure_period)
range(data$recent_ab_days)
range(data$broad_ab_prescriptions)
range(data$interval_mean)
range(data$interval_sd)
```


```{r}
data%>% summary_factorlist(dependent, explanatory)
```


```{r}
data%>% summary_factorlist(dependent, contd)
```

# outliers replaced 0.9999
```{r }
data=df

N1=quantile(data$total_ab,0.9999,na.rm = T)
N2=quantile(data$ab_types,0.9999,na.rm = T)
N3=quantile(data$exposure_period,0.9999,na.rm = T)
N4=quantile(data$recent_ab_days,0.9999,na.rm = T)
N5=quantile(data$broad_ab_prescriptions,0.9999,na.rm = T)
N6=quantile(data$interval_mean,0.9999,na.rm = T)
N7=quantile(data$interval_sd,0.9999,na.rm = T)

N=c(N1,N2,N3,N4,N5,N6,N7)
N

col=c("total_ab","ab_types","exposure_period","recent_ab_days","broad_ab_prescriptions","interval_mean","interval_sd")
```


```{r}

for (i in 1:7) {# just replace total ab
  data[,col[i]]=ifelse( data[,col[i]]>=N[i],N[i], data[,col[i]])
}

range(data$total_ab)
range(data$ab_types)
range(data$exposure_period)
range(data$recent_ab_days)
range(data$broad_ab_prescriptions)
range(data$interval_mean)
range(data$interval_sd)

```

```{r}
data%>% summary_factorlist(dependent, explanatory)
```


```{r}
data%>% summary_factorlist(dependent, contd)
```



# outliers replaced 0.999
```{r }
data=df
N1=quantile(data$total_ab,0.999,na.rm = T)
N2=quantile(data$ab_types,0.999,na.rm = T)
N3=quantile(data$exposure_period,0.999,na.rm = T)
N4=quantile(data$recent_ab_days,0.999,na.rm = T)
N5=quantile(data$broad_ab_prescriptions,0.999,na.rm = T)
N6=quantile(data$interval_mean,0.999,na.rm = T)
N7=quantile(data$interval_sd,0.999,na.rm = T)

N=c(N1,N2,N3,N4,N5,N6,N7)
N

col=c("total_ab","ab_types","exposure_period","recent_ab_days","broad_ab_prescriptions","interval_mean","interval_sd")
```


```{r}
data=df

for (i in 1:7) {# just replace total ab
  data[,col[i]]=ifelse( data[,col[i]]>=N[i],N[i], data[,col[i]])
}

range(data$total_ab)
range(data$ab_types)
range(data$exposure_period)
range(data$recent_ab_days)
range(data$broad_ab_prescriptions)
range(data$interval_mean)
range(data$interval_sd)

```

```{r}
data%>% summary_factorlist(dependent, explanatory)
```


```{r}
data%>% summary_factorlist(dependent, contd)
```



# outliers replaced 0.99
```{r }
data=df
N1=quantile(data$total_ab,0.99,na.rm = T)
N2=quantile(data$ab_types,0.99,na.rm = T)
N3=quantile(data$exposure_period,0.99,na.rm = T)
N4=quantile(data$recent_ab_days,0.99,na.rm = T)
N5=quantile(data$broad_ab_prescriptions,0.99,na.rm = T)
N6=quantile(data$interval_mean,0.99,na.rm = T)
N7=quantile(data$interval_sd,0.99,na.rm = T)

N=c(N1,N2,N3,N4,N5,N6,N7)
N

col=c("total_ab","ab_types","exposure_period","recent_ab_days","broad_ab_prescriptions","interval_mean","interval_sd")
```


```{r}
data=df

for (i in 1:7) {# just replace total ab
  data[,col[i]]=ifelse( data[,col[i]]>=N[i],N[i], data[,col[i]])
}

range(data$total_ab)
range(data$ab_types)
range(data$exposure_period)
range(data$recent_ab_days)
range(data$broad_ab_prescriptions)
range(data$interval_mean)
range(data$interval_sd)

```

```{r}
data%>% summary_factorlist(dependent, explanatory)
```


```{r}
data%>% summary_factorlist(dependent, contd)
```



# outliers replaced 0.9
```{r }
data=df

N1=quantile(data$total_ab,0.9,na.rm = T)
N2=quantile(data$ab_types,0.9,na.rm = T)
N3=quantile(data$exposure_period,0.9,na.rm = T)
N4=quantile(data$recent_ab_days,0.9,na.rm = T)
N5=quantile(data$broad_ab_prescriptions,0.9,na.rm = T)
N6=quantile(data$interval_mean,0.9,na.rm = T)
N7=quantile(data$interval_sd,0.9,na.rm = T)

N=c(N1,N2,N3,N4,N5,N6,N7)
N

col=c("total_ab","ab_types","exposure_period","recent_ab_days","broad_ab_prescriptions","interval_mean","interval_sd")
```


```{r}

for (i in 1:7) {# just replace total ab
  data[,col[i]]=ifelse( data[,col[i]]>=N[i],N[i], data[,col[i]])
}

range(data$total_ab)
range(data$ab_types)
range(data$exposure_period)
range(data$recent_ab_days)
range(data$broad_ab_prescriptions)
range(data$interval_mean)
range(data$interval_sd)

```

```{r}
data%>% summary_factorlist(dependent, explanatory)
```


```{r}
data%>% summary_factorlist(dependent, contd)
```
