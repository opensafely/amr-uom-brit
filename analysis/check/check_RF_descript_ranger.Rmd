---
title: " Descriptive stat of RF classification"
---

```{r setup, include=FALSE}
library('tidyverse')
library("ggplot2")
library("plyr")
library('dplyr')
library('lubridate')
library('stringr')
library("data.table")
library("ggpubr")
library("finalfit")
```


# variable importance
```{r}
model_rf=readRDS(here::here("output","RF_model_ranger.rds"))
```


```{r}
v<-as.vector(model_rf$variable.importance)
w<-as.vector(names(model_rf$variable.importance))
DF<-cbind(w,v)
DF<-as.data.frame(DF)

DF$w <- factor(DF$w, levels =unique(DF$w[order(DF$v)]))

ggplot(DF,aes(x=w, y=v))+ 
      geom_point()+
      coord_flip()+
      ylab("Variable Importance")+
      xlab("")+
      ggtitle("Variable importance")



imps <- data.frame(var = names(model_rf$variable.importance),
                   imps = model_rf$variable.importance/max(model_rf$variable.importance))
imps %>% 
  ggplot(aes(imps, x = reorder(var, imps))) +
  geom_point(size = 3, colour = "#ff6767") +
  coord_flip() +
  labs(x = "Predictors", y = "Importance scores") +
  theme_bw(18)
```

# read table
```{r}
data=read_rds(here::here("output","all_ranger.rds"))
data$decile=as.factor(data$decile)
```

# frequency table
```{r}
# select variables
explanatory<- c("total_ab_group","ab_types_group","exposure_period_group","recent_ab_days_group","broad_ab_prescriptions_group","interval_mean_group","interval_sd_group")
dependent <- "decile"
data %>% summary_factorlist(dependent, explanatory)
```


# descriptive sata
```{r}
data %>% ff_glimpse(dependent, explanatory)
```

# graph

# line chart
```{r }

all.data=list()

for (i in 1:length(explanatory)) {
  
  tbl=data.frame(table(data[,"decile"],data[,explanatory[i]]))
  
    ggplot(data=tbl,aes(y=Freq,x=Var1, group=Var2, color=Var2))+
    geom_line()+
    ggtitle(explanatory[i])+
    xlab("probability decile") + 
    ylab("")+ 
    labs(fill="quartiles")+
    theme_bw(18)               
}
```

# line chart %
```{r }

for (i in 1:length(explanatory)) {
  
  tbl=data.frame(table(data[,"decile"],data[,explanatory[i]]))
  tbl=tbl%>% group_by(Var1)%>% mutate(value=round(Freq/sum(Freq),2))

  print(
    
    ggplot(data=tbl,aes(x=Var1,y=value, group=Var2, color=Var2))+
    geom_line()+
   
 ggtitle(explanatory[i])+
  xlab("probability decile") + ylab("") + labs(fill="quartiles")+
  scale_y_continuous(labels = scales::percent)+
 
# label
 #geom_text(aes(label = paste0(value*100,"%")), 
 #           position = position_stack(vjust = 0.5), size = 2) +
 #   geom_text(aes(label = paste0(value*100,"%")),
    #        vjust = "inward", hjust = "inward",
    #        show.legend = FALSE) + 
# colour
   scale_fill_manual(values=c("#CC6666", "#9999CC", "#66CC99","#6699FF"))
 
 )

}

```

