---
title: "classification comparison: RF "
---

```{r setup, include=FALSE}
library('tidyverse')

library('tidyverse')
library("ggplot2")
library("plyr")
library('dplyr')
library('lubridate')
library('stringr')
library("data.table")
library("ggpubr")
library("finalfit")

```




# descriptive stat 
```{r}
data=read_rds(here::here("output","all_ranger.rds"))
data$decile=as.factor(data$decile)
# select variables
explanatory<- c("total_ab_group","ab_types_group","exposure_period_group","recent_ab_days_group","broad_ab_prescriptions_group","interval_mean_group","interval_sd_group")
dependent <- "decile"
tbl=data %>% summary_factorlist(dependent, explanatory)
tbl
```

# grid bar
```{r }

#for (i in 1:length(explanatory)) {
  # tbl=data.frame(table(data[,"decile"],data[,explanatory[i]]))

 # print(tbl)
  
 # print(
    data$total_ab_group=as.factor(data$total_ab_group)


    ggplot(data=data,aes(y=total_ab,x=decile))+
    geom_line()+
        facet_grid(rows = vars(total_ab_group),scales = "free") 
   
# ggtitle("total_ab_group"+
 # xlab("total_ab") + ylab("probability decile") + labs(fill="quartiles")+
 # scale_y_continuous(labels = scales::percent)+
 
# label
 #geom_text(aes(label = paste0(value*100,"%")), 
 #           position = position_stack(vjust = 0.5), size = 2) +
 #   geom_text(aes(label = Freq),
#            vjust = "inward", hjust = "inward",
#            show.legend = FALSE) + 
# colour
  # scale_fill_manual(values=c("#CC6666", "#9999CC", "#66CC99","#6699FF"))
 
 #)

#}

```

```{r}
    data$total_ab_group=as.factor(data$total_ab_group)
    ggplot(data=data,aes(y=prob,x=total_ab, group=total_ab_group, color=total_ab_group))+
    geom_point()+
  
   scale_fill_manual(values=c("#CC6666", "#9999CC", "#66CC99","#6699FF"))
```


# line chart
```{r }

all.data=list()

for (i in 1:length(explanatory)) {
  
  tbl=data.frame(table(data[,"decile"],data[,explanatory[i]]))
  
  tbl$group=explanatory[i]
  
  all.data[i]=tbl
}

data=rbindlist(all.data)
    
    ggplot(data=data,aes(y=Freq,x=Var1, group=Var2, color=Var2))+
    geom_line()+
   
 ggtitle(explanatory[i])+
  xlab("probability decile") + ylab("") + labs(fill="quartiles")+
 # scale_y_continuous(labels = scales::percent)+
 
# label
 #geom_text(aes(label = paste0(value*100,"%")), 
 #           position = position_stack(vjust = 0.5), size = 2) +
 #   geom_text(aes(label = Freq),
#            vjust = "inward", hjust = "inward",
#            show.legend = FALSE) + 
# colour
   scale_fill_manual(values=c("#CC6666", "#9999CC", "#66CC99","#6699FF"))+
 
    facet_grid(rows = vars(group)
               
               
               
               
               
               
               
               
               
               
               ) 



```

# line chart %
```{r }

for (i in 1:length(explanatory)) {
  
  tbl=data.frame(table(data[,"decile"],data[,explanatory[i]]))
  tbl=tbl%>% group_by(Var1)%>% mutate(value=round(Freq/sum(Freq),2))

  print(
    
    ggplot(data=tbl,aes(x=Var1,y=value, group=Var2, color=Var2))+
    geom_line()+
   
 ggtitle(explanatory[i])+
  xlab("probability decile") + ylab("") + labs(fill="quartiles")+
  scale_y_continuous(labels = scales::percent)+
 
# label
 #geom_text(aes(label = paste0(value*100,"%")), 
 #           position = position_stack(vjust = 0.5), size = 2) +
 #   geom_text(aes(label = paste0(value*100,"%")),
    #        vjust = "inward", hjust = "inward",
    #        show.legend = FALSE) + 
# colour
   scale_fill_manual(values=c("#CC6666", "#9999CC", "#66CC99","#6699FF"))
 
 )

}

```







```{r eval=FALSE, include=FALSE}

rm(list=ls())

data <- read_rds(here::here("output","validation_ranger.rds"))

data$decile=as.factor(data$decile)
# select variables
explanatory<- c("total_ab_group","ab_types_group","exposure_period_group","recent_ab_days_group","broad_ab_prescriptions_group","interval_mean_group","interval_sd_group")
dependent <- "decile"
tbl=data %>% summary_factorlist(dependent, explanatory)
tbl

```

# line chart 
```{r eval=FALSE, include=FALSE}

for (i in 1:length(explanatory)) {
  
  tbl=data.frame(table(data[,"decile"],data[,explanatory[i]]))

  print(tbl)
  
  print(
    
    ggplot(data=tbl,aes(x=Var1,y=Freq, group=Var2, color=Var2))+
    geom_line()+
   
 ggtitle(explanatory[i])+
  xlab("probability decile") + ylab("") + labs(fill="quartiles")+
  scale_y_continuous(labels = scales::percent)+
 
# label
 #geom_text(aes(label = paste0(value*100,"%")), 
 #           position = position_stack(vjust = 0.5), size = 2) +
    geom_text(aes(label = Freq),
            vjust = "inward", hjust = "inward",
            show.legend = FALSE) + 
# colour
   scale_fill_manual(values=c("#CC6666", "#9999CC", "#66CC99","#6699FF"))
 
 )

}

```

# line chart %
```{r eval=FALSE, include=FALSE}

for (i in 1:length(explanatory)) {
  
  tbl=data.frame(table(data[,"decile"],data[,explanatory[i]]))
  tbl=tbl%>% group_by(Var1)%>% mutate(value=round(Freq/sum(Freq),2))

  print(
    
    ggplot(data=tbl,aes(x=Var1,y=value, group=Var2, color=Var2))+
    geom_line()+
   
 ggtitle(explanatory[i])+
  xlab("probability decile") + ylab("") + labs(fill="quartiles")+
  scale_y_continuous(labels = scales::percent)+
 
# label
 #geom_text(aes(label = paste0(value*100,"%")), 
 #           position = position_stack(vjust = 0.5), size = 2) +
    geom_text(aes(label = paste0(value*100,"%")),
            vjust = "inward", hjust = "inward",
            show.legend = FALSE) + 
# colour
   scale_fill_manual(values=c("#CC6666", "#9999CC", "#66CC99","#6699FF"))
 
 )

}

```



