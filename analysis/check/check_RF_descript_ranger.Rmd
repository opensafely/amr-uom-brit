---
title: " Descriptive stat of RF classification"
---

```{r setup, include=FALSE}
library('tidyverse')
library("ggplot2")
library("plyr")
library('dplyr')
library('lubridate')
library('stringr')
library("data.table")
library("ggpubr")
library("finalfit")
```




# variable importance
## https://brunaw.com/slides/rladies-dublin/RF/intro-to-rf.html#30
```{r}
model_rf=readRDS(here::here("output","RF_model_ranger.rds"))


# calculate relative importance
imps <- data.frame(var = names(model_rf$variable.importance),
                   imps = model_rf$variable.importance/max(model_rf$variable.importance),
                   imps.score=model_rf$variable.importance)

# rename variable
imps$var
imps$var=c("Total antibiotics","Antibiotic types","Exposure period","Recent exposure", "Broad-spectrum antibiotics","Prescribing intervals (mean)", "Prescribing intervals (SD)")
```


```{r}
# importance plot
imps %>% 
  ggplot(aes(imps, x = reorder(var, imps))) +
  geom_point(size = 3, colour = "grey60") +
  coord_flip() +
  labs(x = "", y = "Importance") +
  theme_bw(15)

imps %>% 
  ggplot(aes(imps.score, x = reorder(var, imps.score))) +
  geom_point(size = 3, colour = "grey60", ) +
  coord_flip() +
  labs(x = "", y = "Importance Score") +
  theme_bw(15)
```

# read table
```{r}
data=read_rds(here::here("output","all_ranger.rds"))
data$decile=as.factor(data$decile)

```


# frequency table
```{r}
# select variables
explanatory<- c("total_ab_group","ab_types_group","exposure_period_group","recent_ab_days_group","broad_ab_prescriptions_group","interval_mean_group","interval_sd_group")
dependent <- "decile"

table=data %>% summary_factorlist(dependent, explanatory)

round_tbl=table
#remove percentage
for (i in 3:12) {
  round_tbl[,i]=gsub("\\(.*?\\)","",round_tbl[,i])

}

# midpoint rounding
roundmid_any <- function(x, to=6){
  ceiling(x/to)*to - (floor(to/2)*(x!=0))
}

for (i in 3:12) {
round_tbl[,i]=roundmid_any(as.numeric(round_tbl[,i]))# decile group 1-10

colnames(round_tbl)[i] = paste("decile",i-2,"_midpoint6")

}

# rename levels for type and broad
round_tbl[6,2] <-2
round_tbl[7,2] <-3

round_tbl[17,2] <-2
round_tbl[18,2] <-3

write.csv(round_tbl,here::here("output","crosstab.csv"))
write.csv(table,here::here("output","crosstab_origin.csv"))


```


# descriptive stat
```{r}
explanatory<- c("total_ab","ab_types","exposure_period","recent_ab_days","broad_ab_prescriptions","interval_mean","interval_sd")
dependent <- "decile"

table=data %>% summary_factorlist(dependent, explanatory, cont = "median")

write.csv(table,here::here("output","factor.range.csv"))

```


```{r}
contd<- c("total_ab","ab_types","exposure_period","recent_ab_days","broad_ab_prescriptions","interval_mean","interval_sd")

explanatory<- c("total_ab_group","ab_types_group","exposure_period_group","recent_ab_days_group","broad_ab_prescriptions_group","interval_mean_group","interval_sd_group")

temp.list=list()

for (i in 1:7) {

Q1=tapply(data[,contd[i]],data[,explanatory[i]], quantile, p=0.25)  
Q3=tapply(data[,contd[i]],data[,explanatory[i]], quantile, p=0.75)  
Q2=tapply(data[,contd[i]],data[,explanatory[i]], quantile, p=0.5)  


temp.tbl= data.frame(Q1,Q3)
temp.tbl$variables=explanatory[i]
temp.tbl$levels=paste0(explanatory[i],1:nrow(temp.tbl))
temp.tbl$median=Q2
temp.list[[i]]<- temp.tbl

}

table=rbindlist(temp.list)

table


```

# graph

# line chart
```{r }

all.data=list()

for (i in 1:length(explanatory)) {
  
  tbl=data.frame(table(data[,"decile"],data[,explanatory[i]]))
  
  DF=table%>%filter(variables==explanatory[i])# filter variables
  
  temp=vector()
  for (j in 1:nrow(DF)) {
  temp[j]= paste0("(",round(DF[j,1]),",",round(DF[j,2]),")")
  }

  
  print(
    ggplot(data=tbl,aes(y=Freq,x=Var1, group=Var2, color=Var2))+
      geom_line()+
      labs(title=imps$var[i],
      x="probability decile",
      y="",
      color="Range (min, max)")+ 
      scale_color_manual(labels = temp, values=c("#CC6666", "#9999CC", "#66CC99","#6699FF")) +
      theme_bw()   )
}
```

# line chart %
```{r }


for (i in 1:length(explanatory)) {
  
  tbl=data.frame(table(data[,"decile"],data[,explanatory[i]]))
  tbl=tbl%>% group_by(Var1)%>% mutate(value=round(Freq/sum(Freq),2))

  DF=table%>%filter(variables==explanatory[i])# filter variables
  
  temp=vector()
  for (j in 1:nrow(DF)) {
  temp[j]= paste0("Level",j," (",round(DF[j,1]),",",round(DF[j,2]),")")
  }

  print(
    ggplot(data=tbl,aes(y=value,x=Var1, group=Var2,color=Var2))+
      geom_line(size=1)+
      labs(title=paste0(imps$var[i],"- levels (Q1, Q3)"),
      x="Probability level",
      y="",
      color="")+ #legend title
      scale_color_manual(labels = temp, values=c("#CC6666", "#9999CC", "#66CC99","#6699FF")) +
      scale_y_continuous(labels = scales::percent)+
      theme_bw()+
      theme(legend.position="top")
  )
  
  
#  print(
    
 #   ggplot(data=tbl,aes(x=Var1,y=value, group=Var2, color=Var2))+
 #   geom_line()+
 #  
# ggtitle(explanatory[i])+
 # xlab("probability decile") + ylab("") + labs(fill="quartiles")+
 #
# label
 #geom_text(aes(label = paste0(value*100,"%")), 
 #           position = position_stack(vjust = 0.5), size = 2) +
 #   geom_text(aes(label = paste0(value*100,"%")),
    #        vjust = "inward", hjust = "inward",
    #        show.legend = FALSE) + 
# colour
  # scale_fill_manual(values=c("#CC6666", "#9999CC", "#66CC99","#6699FF"))
 
# )

}

```

# subgroup(by total ab level)

```{r}
df=data
#rm(list=ls())

# read table
#df=read_rds(here::here("output","all_ranger.rds"))
#contd<- c("ab_types","exposure_period","recent_ab_days","broad_ab_prescriptions","interval_mean","interval_sd")

for (i in 1:6) {
Q1=tapply(df[,contd[i]],df[,"total_ab_group"],quantile,p=0.25)
Q2=tapply(df[,contd[i]],df[,"total_ab_group"],quantile,p=0.5)
Q3=tapply(df[,contd[i]],df[,"total_ab_group"],quantile,p=0.75)


tbl=data.frame(Q1,Q2,Q3)
tbl$variables=contd[i]
tbl$levels=paste0("total_ab_group",1:nrow(tbl))

print(tbl)
}


```