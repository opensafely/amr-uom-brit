---
title: "Random Forest"
---

```{r setup, include=FALSE}
#library(knitr)
library(dplyr)
#library(skimr)
library('tidyverse')
#library("ggplot2")
#library(caret)
knitr::opts_chunk$set(echo = TRUE)
options(knitr.table.format="html")

```

# import dataset
```{r }
#train_Y <- read_rds("/Users/yayang/Documents/GitHub/amr-uom-brit/output/train_Y.rds")
train_Y <- read_rds(here::here("output","train_Y.rds"))
train_Y=as.factor(train_Y)
#train_X <- read_rds("/Users/yayang/Documents/GitHub/amr-uom-brit/output/train_X.rds")
train_X <- read_rds(here::here("output","train_X.rds"))
train_X$case=as.factor(train_X$case)
#valid_Y <- read_rds("/Users/yayang/Documents/GitHub/amr-uom-brit/output/valid_Y.rds")
valid_Y <- read_rds(here::here("output","valid_Y.rds"))
valid_Y=as.factor(valid_Y)
#valid_X <- read_rds("/Users/yayang/Documents/GitHub/amr-uom-brit/output/valid_X.rds")
valid_X <- read_rds(here::here("output","valid_X.rds"))
valid_X$case=as.factor(valid_X$case)

#df=sample_n(df,5000)
table(train_X$case)
table(valid_X$case)

n=nrow(train_X)
```

train model
```{r}
library(pROC)
library(randomForest)

set.seed(1024)
result = expand.grid(
  ntree=c(1000,2000),
#  sampsize = c(round(n*0.6), round(n*0.8), round(n*0.9)),
  nodesize = c( 5,50),
 # mtry=1:sqrt(ncol(train_X)-1),
  valid_auc = NA)
               

for (i in 1:nrow(result)) {
  
  rf.model <- randomForest(formula = case ~ ., data = train_X, 
                           replace = TRUE,
                           ntree =  result[i,'ntree'],
                           sampsize = round(n*0.8),
                           nodesize =  result[i,'nodesize'],
                           mtry = sqrt(ncol(train_X)-1)
                          )
  
  pred.y <- predict(rf.model, valid_X, type = 'prob')[,2]
  roc_valid <- roc(valid_Y ~ pred.y)
  
  result[i,'valid_auc'] <- roc_valid[['auc']]
  
  plot(roc_valid)
  print(roc_valid)
  print(rf.model)
  
}

result
```
```{r}
used_count <- varUsed(rf.model)
#names(used_count) <- colnames(train_X)
sort(used_count, decreasing = TRUE)
```


```{r}
count_table <- varUsed(rf.model, by.tree = TRUE)
#rownames(count_table) <- colnames(train_X)
```

```{r}
importance(rf.model)
varImpPlot(rf.model)
```

