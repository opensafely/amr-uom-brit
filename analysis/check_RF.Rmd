---
title: "AB types"
output: 
  html_document:
   toc: true
   toc_depth: 2
   toc_float:
     collapsed: false
     smooth_scorll: false
---

```{r setup, include=FALSE}
library(knitr)
library(dplyr)

library('tidyverse')

library("ggplot2")

library(caret)
knitr::opts_chunk$set(echo = TRUE)
options(knitr.table.format="html")
```

```{r}
#df <- read_rds("/Users/yayang/Documents/GitHub/amr-uom-brit/output/matched_ab.rds")
df <- read_rds(here::here("output","matched_ab.rds"))
count(df)

df=df[!is.na(df$case),]
count(df)

df=df%>% select( "patient_id" , "patient_index_date","case","subclass",
                 "AB_1_type","AB_6wk_type" , "ab_6w_binary" ,
             "AB_6wk" ,"total_ab", "ab_prescriptions","ab_types",
              "prescribe_times","exposure_period"  ,
               "recent_ab_days",  
              "broad_prop" ,"broad_ab_prescriptions",
             "interval_med" ,  "interval_mean" , "interval_sd" , "interval_CV",
              "length_med" , "length_mean", "length_sd" ,  "length_CV" 
               )
df$exposure_period=-df$exposure_period
df[is.na(df)] <- 0
```


```{r}
# divide data
set.seed(1024)
all_idx <- 1:nrow(df)

train_idx <- sample(all_idx, nrow(df) * 0.8)
test_idx <- all_idx[!all_idx %in% train_idx]

df.train=df[train_idx,]
df.test=df[test_idx,]

length(all_idx)
length(train_idx)
length(test_idx)
```


```{r echo=TRUE}
# develop model

set.seed(123)
df=sample_n(df.train,100)

x=df[,1:79]
y=df[,80]

df$case=as.factor(df$case)
```

# default
```{r echo=TRUE}

#10 folds repeat 3 times
control <- trainControl(method='repeatedcv', 
                        number=5, 
                        repeats=3)
#Metric compare model is Accuracy
metric <- "Accuracy"
set.seed(123)
#Number randomely variable selected is mtry
mtry <- sqrt(ncol(x))
tunegrid <- expand.grid(.mtry=mtry)
rf_default <- train(case~., 
                      data=df, 
                      method='rf', 
                      metric='Accuracy', 
                      tuneGrid=tunegrid, 
                      trControl=control)
print(rf_default)

plot(varImp(rf_default,scale = F), main= "Var Imp: RF 5 fold CV")
```

# Random search
```{r}
#mtry: Number of random variables collected at each split. In normal equal square number columns.
mtry <- sqrt(ncol(x))
#ntree: Number of trees to grow.
ntree <- 3


control <- trainControl(method='repeatedcv', 
                        number=5, 
                        repeats=3,
                        search = 'random')

#Random generate 15 mtry values with tuneLength = 15
set.seed(1)
rf_random <- train(case ~ .,
                   data = df,
                   method = 'rf',
                   metric = 'Accuracy',
                   tuneLength  = 15, 
                   trControl = control)
print(rf_random)
plot(rf_random)
plot(varImp(rf_random,scale = F), main= "Var Imp: RF 5 fold CV")

```



