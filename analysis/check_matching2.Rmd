---
title: "Matching(with replacement) Report"
output: 
  html_document:
   toc: true
   toc_depth: 2
   toc_float:
     collapsed: false
     smooth_scorll: false
---

```{r setup, include=FALSE}
library(knitr)
library(dplyr)
library(kableExtra)
library('tidyverse')
require("gtsummary")
library("ggplot2")
knitr::opts_chunk$set(echo = TRUE)
options(knitr.table.format="html")
```

# <font color=blue>**1:6 matching**</font>
```{r include=FALSE}
# import data
rm(list=ls())
df <- read_rds(here::here("output","matched_patients_2.rds"))
#df= read_rds("/Users/yayang/Documents/GitHub/amr-uom-brit/output/matched_patients.rds")
```


```{r include=FALSE}
# number of patients in case group
num.case=count(df[df$case=="1",])
```

#### Cases: COVID hospital admission / **count:`r num.case`**

```{r include=FALSE}
# number of patients in control group
num.contr=count(df[df$case=="0",])
```

#### Controls: COVID infection /  **count:`r num.contr`**

***

# Matched cohort
#### *1:6 matching by age (within 5 years), sex, region (stp)*

**number of matched controls per case**
```{r echo=FALSE }

control=subset(df,df$case=="0")
control=control%>%group_by(subclass)%>%summarise(match.counts=n())

# number of matched controls per case
table(control$match.counts)
# proportional of matched controls per case
round(prop.table(table(control$match.counts)),digits=2)
```

## Sex proportion
case
```{r}
table(df[df$case=="1",]$sex)
round(prop.table(table(df[df$case=="1",]$sex)),digits=2)
```
control
```{r}
table(df[df$case=="0",]$sex)
round(prop.table(table(df[df$case=="0",]$sex)),digits=2)
```


## STP proportion 

case
```{r}
ggplot(df[df$case==1,], aes(x = stp)) +  
  geom_bar(aes(y = (..count..)/sum(..count..)))+
   scale_y_continuous(labels=scales::percent) +
          ylab("relative frequencies") 
```
control
```{r}
ggplot(df[df$case==0,], aes(x = stp)) +  
  geom_bar(aes(y = (..count..)/sum(..count..)))+
   scale_y_continuous(labels=scales::percent) +
          ylab("relative frequencies") 
```



```{r}
ggplot(df, aes(stp)) + 
          geom_bar(aes( stat="count")) + 
          ylab("frequencies") +
          facet_grid(case~.)
```


## Age distribution

### case:25-50-75 percentile
```{r}
df$case=as.factor(df$case)
case=subset(df,df$case==1)
quantile(case$age, c(0,.25, .50, .75,1))
```
### control:25-50-75 percentile
```{r}

control=subset(df,df$case==0)
quantile(control$age, c(0,.25, .50, .75,1))
```


### **Figure 1: age distribution **
```{r  echo=FALSE }
df$case=as.factor(df$case)
df.sub=df%>%group_by(case)%>%mutate(mean= mean(age))

ggplot(df, aes(x=age, fill=case, color=case)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.1,bins=30)+
  geom_density(alpha=0.5)+
  geom_vline(data=df.sub, aes(xintercept=mean, color=case),
             linetype="dashed")+
  scale_x_continuous(breaks = seq(0, 110, by=10))

```

### **Figure 2: age distribution by numbers of matches**

```{r  echo=FALSE }
df.sub=df.sub%>%group_by(case,subclass)%>%mutate(num.matches=n())
df.sub=df.sub%>%group_by(case,num.matches)%>%mutate( matches.mean=mean(age))
df.sub$num.matches=as.factor(df.sub$num.matches)

df.sub.contr=subset(df.sub, case=="0")
df.sub.case=subset(df.sub, case=="1")

ggplot(df.sub.contr, aes(x=age)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.5,bins=30)+
  geom_density(alpha=0.5)+
  geom_vline(data=df.sub.contr, aes(xintercept= matches.mean),
             linetype="dashed")+
  scale_x_continuous(breaks = seq(0, 110, by=20))+
  labs(title="Control groups by number of matches")+
  facet_grid(num.matches ~.)

ggplot(df.sub.case, aes(x=age)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.5,bins=30)+
  geom_density(alpha=0.5)+
  geom_vline(data=df.sub.case, aes(xintercept= matches.mean),
             linetype="dashed")+
  scale_x_continuous(breaks = seq(0, 110, by=20))+
  labs(title="Case group")

```

###  **Figure 3: average age of subclass**
control: average mean
case: mean
```{r  echo=FALSE }

df$case=as.factor(df$case)
df.sub=df%>%group_by(case,subclass)%>% summarise(grp.age= mean(age)) #
df.sub=df.sub%>%group_by(case)%>%mutate(grp.mean.age= mean(grp.age))

ggplot(df.sub, aes(x=grp.age, fill=case, color=case)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.1,bins=30)+
  geom_density(alpha=0.5)+
  geom_vline(data=df.sub, aes(xintercept=grp.mean.age, color=case),
             linetype="dashed")+
  scale_x_continuous(breaks = seq(0, 110, by=10))

```
###  **Figure 4: random one age of subclass**
control: randomly pick one patient
case: mean
```{r  echo=FALSE }

df$case=as.factor(df$case)
df.random=df%>%group_by(case,subclass)%>% sample_n(size = 1) 

df.sub=df.random%>%group_by(case)%>%mutate(mean= mean(age))

ggplot(df.random, aes(x=age, fill=case, color=case)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.1,bins=30)+
  geom_density(alpha=0.5)+
  geom_vline(data=df.sub, aes(xintercept=mean, color=case),
             linetype="dashed")+
  scale_x_continuous(breaks = seq(0, 110, by=10))

```


##  Matching Variables table

```{r  echo=FALSE }

df.m=df%>% select(case, age, sex, stp)
df$age=as.numeric(df$age)

df.m %>%
  tbl_summary(
    by = case,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)")) %>%
  bold_labels()

```


# Unmatched cases
```{r include=FALSE}
# import data
rm(list=ls())
df1 <- read_rds(here::here("output","matched_patients_2.rds"))
#df1= read_rds("/Users/yayang/Documents/GitHub/amr-uom-brit/output/matched_patients.rds")
df1=df1%>%select( "case","patient_id" ,"patient_index_date" ,"age" ,"sex"  ,"stp" ,"cal_YM" ) 
df1=subset(df1,case==1)
df1$matched="1"

df2 <- read_rds(here::here("output","unmatched_patients_2.rds"))
#df2= read_rds("/Users/yayang/Documents/GitHub/amr-uom-brit/output/unmatched_patients.rds")
df2=df2%>%select( "case","patient_id" ,"patient_index_date" ,"age" ,"sex"  ,"stp" ,"cal_YM" ) 
df2=subset(df2,case==1)
df2$matched="0"

df=rbind(df1,df2)

```


```{r include=FALSE}
num1=count(df[df$matched=="1",])
num2=count(df[df$matched=="0",])
```

#### Matcthed case: **count:`r num1`**
#### Unmatcthed case: **count:`r num2`**

***

## Sex proportion
case
```{r}
table(df[df$matched=="1",]$sex)
round(prop.table(table(df[df$matched=="1",]$sex)),digits=2)
```
control
```{r}
table(df[df$matched=="0",]$sex)
round(prop.table(table(df[df$matched=="0",]$sex)),digits=2)
```


## STP proportion 

matched
```{r}
ggplot(df[df$matched==1,], aes(x = stp)) +  
  geom_bar(aes(y = (..count..)/sum(..count..)))+
   scale_y_continuous(labels=scales::percent) +
          ylab("relative frequencies") 

```

unmatched
```{r}

ggplot(df[df$matched==0,], aes(x = stp)) +  
  geom_bar(aes(y = (..count..)/sum(..count..)))+
   scale_y_continuous(labels=scales::percent) +
          ylab("relative frequencies") 
```

```{r}
ggplot(df, aes(stp)) + 
          geom_bar(aes( stat="count")) + 
          ylab("frequencies") +
          facet_grid(matched~.)
```


## Age distribution

### matched:25-50-75 percentile
```{r}
case=subset(df,df$matched==1)
quantile(case$age, c(0,.25, .50, .75,1))
```
### unmatched:25-50-75 percentile
```{r}

control=subset(df,df$matched==0)
quantile(control$age, c(0,.25, .50, .75,1))
```


### **Figure 1: age distribution **
```{r  echo=FALSE }
df.sub=df%>%group_by(matched)%>%mutate(mean= mean(age))

ggplot(df, aes(x=age, fill=matched, color=matched)) +
  geom_histogram(aes(y=..density..), position="identity", alpha=0.1,bins=30)+
  geom_density(alpha=0.5)+
  geom_vline(data=df.sub, aes(xintercept=mean, color=matched),
             linetype="dashed")+
  scale_x_continuous(breaks = seq(0, 110, by=10))

```




### Matching variables table

```{r echo=FALSE}

df$matched=as.factor(df$matched)
df %>%
  select(matched,age,sex,stp) %>%
  tbl_uvregression(
    method = glm,
    y = matched,
    method.args = list(family = binomial),
    exponentiate = TRUE,
    pvalue_fun = ~style_pvalue(.x, digits = 2)
  ) %>%
  add_global_p() %>%  # add global p-value 
  add_nevent() %>%    # add number of events of the outcome
  bold_p() %>%        # bold p-values under a given threshold (default 0.05)
   bold_labels()

```




