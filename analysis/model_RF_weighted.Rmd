---
title: "Random Forest"
---

```{r setup, include=FALSE}

library(dplyr)
library('tidyverse')
library("ggplot2")
library(ranger)

knitr::opts_chunk$set(echo = TRUE)
options(knitr.table.format="html")

```

# import dataset
```{r }

#train <- read_rds("/Users/yayang/Documents/GitHub/amr-uom-brit/output/train.rds")
train <- read_rds(here::here("output","train_cat.rds"))
train$case=as.factor(train$case)

table(train$case)
prop.table(table(train$case))


```


```{r }

#valid <- read_rds("/Users/yayang/Documents/GitHub/amr-uom-brit/output/valid.rds")
valid<- read_rds(here::here("output","valid_cat.rds"))
valid$case=as.factor(valid$case)

table(valid$case)
prop.table(table(valid$case))

```


pick variable
```{r}
names(train)

col=c("case","total_ab_group","ab_types_group",
      "exposure_period_group","recent_ab_days_group",
      "broad_ab_prescriptions_group",
      "interval_med_group" ,"interval_sd_group")

# abtype
train=train[col]
valid=valid[col]
```


train model
```{r}
library(ranger)

n=nrow(train)

set.seed(1024)
#for (i in 1:nrow(result)) {
  
rf.model <- ranger(formula = case ~ ., 
                   data = train,
                   num.trees =  1000,
                   min.node.size = 100,
                   mtry = 3,
                   importance = "impurity",
                   replace = TRUE,
                   sample.fraction = c(0.5,0.5),
                   probability = TRUE
                          )
  print(rf.model)
```

```{r}
importance(rf.model)
saveRDS(rf.model,here::here("output","model_RF_weighted.rds"))
```


```{r}
library(pROC)

set.seed(1024)
pred.y <- predictions(rf.model)[,2]
  roc_valid <- roc(train$case~ pred.y)
  
   #result[i,'valid_auc'] <- roc_valid[['auc']]
  
  plot(roc_valid)
  print(roc_valid)
#}

#result
```

```{r}
set.seed(1024)
pred.y <- predictions(rf.model, train)[,2]
  roc_valid <- roc(train$case~ pred.y)
  
   #result[i,'valid_auc'] <- roc_valid[['auc']]
  
  plot(roc_valid)
  print(roc_valid)
#}

#result
```


```{r}
#names(train)
#used_count <- varUsed(rf.model)
#train=train[,-train$case]
#names(used_count) <- colnames(train)
#sort(used_count, decreasing = TRUE)
#used_count
```


```{r}
#count_table <- varUsed(rf.model, by.tree = TRUE)
#rownames(count_table) <- colnames(train)
#write.csv(count_table,here::here("output","var_tree.csv"))

```



```{r}
set.seed(1024)
rm(pred.y)
pred.y <- predictions(rf.model, valid)[,2]
roc_valid <- roc( valid$case ~ pred.y)
  
plot(roc_valid)
print(roc_valid)

```


